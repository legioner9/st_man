
<!--+++++++++++++++++++++++++++++++++++++++++++  0  +++++++++++++++++++++++++++++++++++++++++++--->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Проект OpenNet: MAN iptables (8) Команды системного администрирования (FreeBSD и Linux)</title><meta name="KeyWords" content="man, manual, MAN, системное руководство, linux, FreeBSD, OpenBSD, Solaris, ядро, программы, системный вызов, iptables"><meta name="viewport" content="width=device-width, initial-scale=1"></head>


<body link="#0000FF" vlink="#000080" text="#000000" bgcolor="#E3E4D0" alink="#FF00FF">
<link rel="stylesheet" href="/opennet4.css" type="text/css">
<!--htdig_noindex-->
<form method="get" action="https://www.opennet.ru/search.shtml">
<aside>
<div style="width: 100%; text-align: right; font-size: 70%; background: #E9EAD6; margin-bottom:-10px;">
Профиль: <b><a href="/~" rel="nofollow" title="/~ - сводная страница участника"><u>Аноним</u></a></b> (<a href="https://www.opennet.ru/cgi-bin/openforum/vsluhboard.cgi?az=login">вход</a> | <a href="https://www.opennet.ru/cgi-bin/openforum/vsluhboard.cgi?az=user_register">регистрация</a>)</div>

<table cellspacing="0" cellpadding="0" width="100%" border="0">
<tbody><tr>
<td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left" valign="BOTTOM" bgcolor="#E9EAD6" width="300">
<a href="https://www.opennet.ru/"><img src="/opennet2.gif" alt="The OpenNET Project" height="60" width="249" border="0"></a><br>
</td>
<td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left" bgcolor="#E9EAD6" align="CENTER" width="100">

</td><td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left;padding-bottom:10px;" bgcolor="#E9EAD6" align="CENTER" width="50%">
<table width="100%" border="0">
<tbody><tr>
<td width="22%">
 <a href="https://www.opennet.ru/opennews/" class="h"><b>НОВОСТИ</b></a> (<a href="https://www.opennet.ru/news/opennet.shtml" class="h">+</a>)
</td><td width="18%%">
  <a href="https://www.opennet.ru/mp/" class="h"><b>КОНТЕНТ</b></a>
</td><td width="14%">
  <a href="http://wiki.opennet.ru" class="h"><b>WIKI</b></a>
</td><td width="14%">
   <a href="https://www.opennet.ru/man.shtml" class="h"><b>MAN'ы</b></a>
</td><td width="16%">
   <a href="https://www.opennet.ru/forum/" class="h"><b>ФОРУМ</b></a>
</td><td width="16%">
<a href="https://www.opennet.ru/search.shtml" class="h" onmouseover="document.getElementById('form12').style.display='block';">Поиск</a>&nbsp;(<a href="https://www.opennet.ru/keywords/" class="h">теги</a>)
<input id="form12" style="display: none;" size="10" name="words" value="" title="для поиска в google наберите &quot;g фраза&quot;" type="text">
</td></tr>
</tbody></table>

</td><td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left;padding-bottom:5px;" bgcolor="#E9EAD6" align="right" width="20%">

<a href="https://www.opennet.ru/opennews/opennews_all_utf.rss"><img src="/img/rss.png" alt="RSS" title="RSS" height="16" width="16" border="0"></a>&nbsp;<a href="https://twitter.com/opennetru"><img src="/twitter.png" alt="twitter" title="Twitter" height="16" width="16" border="0"></a>&nbsp;<a href="https://vk.com/opennet"><img src="/img/vkontakte.gif" title="ВКонтакте" height="16" width="16" border="0"></a>&nbsp;<a href="https://zen.yandex.ru/opennet"><img src="/img/zen.gif" title="Yandex Zen" height="16" width="16" border="0"></a>&nbsp;<a href="https://www.facebook.com/OpenNet.News/"><img src="/img/facebook.gif" title="Facebook" height="16" width="16" border="0"></a>&nbsp;<a href="https://telegram.space/opennet_ru"><img src="/img/telegram2.png" title="Telegram" height="16" width="16" border="0"></a>
</td></tr></tbody></table>
</aside>

<style>
    .hdr_mobile {
	text-align: center; 
	display: none;
	margin: 0px;
	padding: 0px;
    }
</style>
<div class="hdr_mobile">
<div style="margin-left: auto; margin-right: auto; width: 100%; height: 70px; border:1px solid #b0b190; min-width: 360px; max-width: 600px; background: #E9EAD6 url('/back.gif') repeat-x bottom left;">
<div style="float:left; width: 249px; height: 60px; margin-top: 10px;">
<a href="https://www.opennet.ru"><img src="/opennet2_lite.gif" style="height: 60px; width: 249px; border: 1px;" alt="The OpenNET Project / Index page"></a>
</div>
<div style="float: left; text-align: center; height: 70px; width: 331px; padding: 5px; margin-left: 10px;">
<br><small>[ <a href="/opennews/">новости</a>&nbsp;/<a href="/opennews/?full_lines=15&amp;lines=15&amp;mid_lines=00">+++</a> | <a href="/forum/">форум</a> | <a href="http://wiki.opennet.ru">wiki</a> | <a href="/keywords/">теги</a>
| <a href="tg://resolve?domain=opennet_ru"><img src="/img/telegram2.png" title="Telegram" style="margin-bottom: -4px;" height="16" width="16" border="0"></a>
]</small>
</div>
</div>
</div>
<div style="clear: both;"></div>


<div style="float: left; width: 279; text-align: left;padding-right: 60px;" id="adv">
</div>
<div style="padding-top: 0px;position:absolute;left:50%;margin-left:-235px;width:470px;" id="adv2">
</div>
<div style="width: 279;float: right;" id="adv3">
</div>
<div style="clear: both;"></div>
<br>
</form>
<!--/htdig_noindex-->

<center><h3><font color="#000088">Интерактивная система просмотра системных руководств (man-ов)</font></h3></center>
<form method="GET" action="/man.shtml"> 
<table cellspacing="0" cellpadding="1" bgcolor="#B0B190" align="center" width="600" border="0">
<tbody><tr>
<td valign="TOP">

<table cellspacing="0" cellpadding="0" bgcolor="#E9EAD6" align="center" width="100%" border="0">
<tbody><tr><td>&nbsp;<font color="#555555">Тема</font></td><td><font color="#555555">Набор</font></td><td><font color="#555555">Категория</font></td><td>&nbsp;</td></tr>
<tr><td>

&nbsp;<input size="20" name="topic" value="iptables" type="text"></td><td><select name="russian">
<option value="4">Solaris man
</option><option value="1">FreeBSD man
</option><option value="3">Разные man
</option><option value="0" selected="">Русские man
</option><option value="2">Linux man
</option><option value="5">POSIX man
</option></select></td>
<td><select size="1" name="category">
	  <option value="" selected="">All
	  </option><option value="1">1
	  </option><option value="2">2
	  </option><option value="3">3
	  </option><option value="4">4
	  </option><option value="5">5
	  </option><option value="6">6
	  </option><option value="7">7
	  </option><option value="8">8
	  </option><option value="9">9
</option></select></td>

<td><input name="submit" value="Показать man" type="submit"></td></tr>
<script async="" src="https://www.google-analytics.com/analytics.js"></script><script language="JavaScript" src="/print.js"></script>
<tr><td colspan="4" align="left">&nbsp;[<a href="/man.shtml">Cписок руководств</a> | <a href="#" onclick="pr('none');">Печать</a>]</td></tr>
</tbody></table>
</td></tr></tbody></table>
</form>
<h3></h3><font size="+2">iptables (8)</font><hr><li>&gt;&gt; <a href="/man.shtml?topic=iptables&amp;category=8&amp;russian=0"><u>iptables</u></a> (8) <font color="#555555"> ( Русские man: Команды системного администрирования )</font></li><li> <a href="/man.shtml?topic=iptables&amp;category=8&amp;russian=2"><u>iptables</u></a> (8) <font color="#555555"> ( Linux man: Команды системного администрирования )</font></li><li><font color="#555555">Ключ <a href="/keywords/iptables.html"><u>iptables</u></a> обнаружен в базе ключевых слов.</font></li>


<a name="lbAB">&nbsp;</a>
<h2>ИМЯ</h2>

iptables - инструмент администрирования фильтра пакетов IPv4 и NAT
<a name="lbAC">&nbsp;</a>
<h2>ОБЗОР</h2>

<b>iptables [-t таблица] -[AD] </b>цепочка описание-правил [опции]

<br>

<b>iptables [-t таблица] -I </b>цепочка [номер-правила] описание-правил [опции]

<br>

<b>iptables [-t таблица] -R </b>цепочка номер-правила описание-правил [опции]

<br>

<b>iptables [-t таблица] -D </b>цепочка номер-правила [опции]

<br>

<b>iptables [-t таблица] -[LFZ] </b>[цепочка] [опции]

<br>

<b>iptables [-t таблица] -N </b>цепочка

<br>

<b>iptables [-t таблица] -X </b>[цепочка]

<br>

<b>iptables [-t таблица] -P </b>цепочка цель [опции]

<br>

<b>iptables [-t таблица] -E </b>старое-имя-цепочки новое-имя-цепочки

<a name="lbAD">&nbsp;</a>
<h2>ОПИСАНИЕ</h2>

<b>Iptables</b>

используется для установки, настройки и просмотра таблиц
правил фильтрации IP-пакетов в ядре Linux.
<p>
Каждая таблица содержит несколько предопределённых цепочек и
может содержать цепочки, определённые пользователем. 
Каждая цепочка - это список правил, которые могут воздействовать на множество
пакетов. Каждое правило определяет, какие действие произвести с пакетами, на
которые оно действует.
Эти действия называются целью, целью может быть и переход на другую
(определённую пользователем) цепочку в этой же таблице.
</p><p>
<a name="lbAE">&nbsp;</a>
</p><h2>ЦЕЛИ</h2>

Правило брандмауэра (межсетевого экрана) определяет критерии для пакета и цели.
Если пакет не попадает под действие правила, проверяется следующее правило в
цепочке;
если попадает - проверяется правило, указанное в цели,
которая может быть именем новой цепочки или одно из специальных целей:
<i>ACCEPT</i>,

<i>DROP</i>,

<i>QUEUE</i>

или
<i>RETURN</i>.

<p>

<i>ACCEPT </i>

принять (пропустить далее) пакет
<i>DROP</i>

проигнорировать (отбросить) пакет.
<i>QUEUE</i>

передать пакет в адресное пространство пользователя
(получение пакета пользовательским процессом зависит
от обработчика очереди; в ядрах 2.4.x
и 2.6.x до 2.6.13 использовался обработчик
<b>ip_queue;</b>

в ядрах начиная с 2.6.14 появился дополнительный обработчик 
<b>nfnetlink_queue;</b>

в этом случае пакеты с целью QUEUE отправляются очереди номер 0;
см. также цель
<b>NFQUEUE</b>

ниже по тексту).
<i>RETURN</i>

остановить применение правил этой цепочки
и передать пакет следующему правилу предыдущей (вызывающей) цепочки.
Если достигается конец встроенной (предопределённой) цепочки или в ней 
к пакету применяется правило с целью 
<i>RETURN,</i>

то окончательное действие над пакетом (цель) определяется стратегией (политикой)
цепочки.
<a name="lbAF">&nbsp;</a>
</p><h2>ТАБЛИЦЫ</h2>

Существует три независимых таблицы
(какие именно таблицы присутствуют в данный момент --
зависит от конфигурации ядра и наличия его модулей).
<dl compact="">
<dt><b>-t, --table </b><i>таблица</i>

</dt><dd>
Задаёт таблицу, к которой будет применена команда.
Если ядро скомпилировано с автоматической загрузкой модулей,
то при необходимости будет загружен модуль, соответствующий таблице.
Итак, таблицы:
<dl compact=""><dt></dt><dd>
<dl compact="">
<dt><b>filter</b>:

</dt><dd>
Таблица используемая по-умолчанию (если опция -t не задана).
Эта таблица содержит предопределённые цепочки
<b>INPUT</b>

(для входящих пакетов - направленных в локальные сокеты),
<b>FORWARD</b>

(для проходящих пакетов) и 
<b>OUTPUT</b>

(для исходящих пакетов - сгенерированных в локальной системе). 
</dd><dt><b>nat</b>:

</dt><dd>
Эта таблица используется, когда встречается пакет, устанавливающий новое
соединение.
Она содержит три предопределённых цепочки:
<b>PREROUTING</b>

(для изменения входящих пакетов),
<b>OUTPUT</b>

(для изменения локально сгенерированных пакетов перед их отправлением) и 
<b>POSTROUTING</b>

(для изменения всех исходящих пакетов).
</dd><dt><b>mangle</b>:

</dt><dd>
Эта таблица используется для специальных изменений пакетов.
Она содержала две предопределённые цепочки в ядрах до версии 2.4.17: 
<b>PREROUTING</b>

(для изменения входящих пакетов до их перенаправления-маршрутизации) и
<b>OUTPUT</b>

(для изменения локально сгенерированных пакетов перед их маршрутизацией).
Начиная с ядер версии 2.4.18, включены ещё три другие предопределённые цепочки: 
<b>INPUT</b>

(для изменения входящих пакетов),
<b>FORWARD</b>

(для изменения проходящих пакетов) и 
<b>POSTROUTING</b>

(для изменения исходящих пакетов).
</dd><dt><b>raw</b>:

</dt><dd>
Используется преимущественно для создания исключений в слежении за соединениями
совместно с целью NOTRACK. Для неё в netfilter сделаны специальные 
вставки, имеющие высший приоритет, и поэтому вызываемые до ip_conntrack
и всех других таблиц. В таблице имеются следующие предопределённые цепочки:
<b>PREROUTING</b>

(для пакетов приходящих из сетевых интерфейсов)
<b>OUTPUT</b>

(для пакетов генерируемых локальными процессами)
</dd></dl>
</dd></dl>

</dd></dl>
<a name="lbAG">&nbsp;</a>
<h2>ОПЦИИ</h2>

Опции 
<b>iptables</b>

могут быть разделены на несколько групп.
<a name="lbAH">&nbsp;</a>
<h3>КОМАНДЫ</h3>

Эти опции определяют действие, выполняемое в данном сеансе работы программы.
В командной строке может быть указана только одна из этих опций,
если противоположное явно не указано в описании.
Длинные команды можно сокращать до первых букв,
но их должно быть достаточно, чтобы программа могла однозначно идентифицировать
команду.
<dl compact="">
<dt><b>-A, --append </b><i>цепочка определение-правила</i>

</dt><dd>
Добавить одно или несколько правил в конец указанной цепочки.
Если имя источника и/или стока (назначения) соответствует нескольким адресам,
правило будет добавлено для всех возможных комбинаций адресов.
</dd><dt><b>-D, --delete </b><i>цепочка определение-правила</i>

</dt><dd>

</dd><dt><b>-D, --delete </b><i>цепочка номер-правила</i>

</dt><dd>
Удалить одно или несколько правил из указанной цепочки.
Существует две версии этой команды: правило может быть указано через его номер в
цепочке (счёт первого правила начинается с 1) или через соответствие
определения правила.
</dd><dt><b>-I, --insert </b><i>цепочка</i> [<i>номер-правила</i>]

</dt><dd>
<i>определение-правила</i>"
В указанной цепочке вставить одно или более правил в позицию заданную номером.
Так, если указан номер 1, правило или правила будут вставлены в начало цепочки.
Это подразумеваемая позиция, если номер не указан.
</dd><dt><b>-R, --replace </b><i>цепочка номер-правила определение-правила</i>

</dt><dd>
Заменить правило в указанной цепочке. Если имена источника и/или стока
соответствуют нескольким адресам,
команда не будет выполнена с сообщением об ошибке. Правила нумеруются с 1.
</dd><dt><b>-L, --list </b>[<i>цепочка</i>]

</dt><dd>
Показать все правила в выбранной цепочке.
Если цепочка не указана, то команда применяется ко всем цепочкам.
Как и всякая другая команда iptables, она воздействует на указанную таблицу
(filter, если таблица не указана), к примеру следующая команда выводит список
правил NAT:
<pre> iptables -t nat -n -L
</pre>

Обратите внимание на опцию
<b>-n</b>

которая часто используется для отключения (медленного) определения имён DNS.
Также можно указать опцию -Z
<b>-Z</b>

(zero), в этом случае автоматически произойдёт перечисление правил цепочки и
обнуление её счётчиков.
Вид результата зависит от других аргументов.
Самый детальный результат может быть получен так:
<pre> iptables -L -v
</pre>

</dd><dt><b>-F, --flush </b>[<i>цепочка</i>]

</dt><dd>
Сбросить выбранную цепочку (все цепочки в таблице, если ни одна не указана).
Это эквивалентно удалению по одному всех правил.
</dd><dt><b>-Z, --zero </b>[<i>цепочка</i>]

</dt><dd>
Обнулить счётчики количества пакетов и байтов во всех или указанной цепочке.
Можно также указать 
<b>-L, --list</b>

чтобы отобразить значения счётчиков непосредственно перед их обнулением (см.
выше).
</dd><dt><b>-N, --new-chain </b><i>цепочка</i>

</dt><dd>
Создать новую, определённую пользователем цепочку с заданным именем.
В момент создания цепочки не должно быть уже существующих целей с указанным
именем.
</dd><dt><b>-X, --delete-chain </b>[<i>цепочка</i>]

</dt><dd>
Удалить цепочку, определённую пользователем.
При этом не должно быть ссылок на удаляемую цепочку.
Если такие ссылки есть, необходимо сначала удалить или изменить правила,
ссылающиеся на удаляемую цепочку.
Если цепочка не указана, из таблицы будут удалены все цепочки кроме встроенных.
</dd><dt><b>-P, --policy </b><i>цепочка цель</i>

</dt><dd>
Определить стратегию для цепочки.
Допустимые цели описаны в разделе 
<b>ЦЕЛИ</b>

настоящего документа.
Стратегия может быть задана только для встроенных цепочек и не может быть задана
для цепочек определённых пользователем.
</dd><dt><b>-E, --rename-chain </b><i>старое-имя новое-имя</i>

</dt><dd>
Переименовать цепочку, определённую пользователем.
Эта команда не изменяет структуру таблицы и используется только в косметических
целях.
</dd><dt><b>-h</b>

</dt><dd>
Подсказка. Выдаёт очень короткое описание синтаксиса команд.
</dd></dl>
<a name="lbAI">&nbsp;</a>
<h3>ПАРАМЕТРЫ</h3>

Следующие параметры предназначены для формирования правил
(используются в командах add, delete, insert, replace и append).
<dl compact="">
<dt><b>-p, --protocol </b>[!] <i>протокол</i>

</dt><dd>
Сетевой протокол применяемого правила или проверяемого пакета.
Допустимые значения:
<i>tcp</i>,

<i>udp</i>,

<i>icmp</i>,

<i>all</i>.

Также можно указывать в виде числа (соответствующего одному из перечисленных ил
иному протоколу).
Названия протоколов также можно брать из файла /etc/protocols.
Знак "!" перед названием протокола инвертирует результат теста.
Число 0 эквивалентно 
<i>all</i>.

Значение
<i>all</i>

соответствует всем протоколами и используется если данный параметр опущен.
</dd><dt><b>-s, --source </b>[!] <i>адрес</i>[/<i>маска</i>]

</dt><dd>
Адрес источника. 
<i>Адресом</i>

может быть сетевое имя, имя хоста (не рекомендуем указывать имена хостов,
разрешаемые через запросы к удалённым DNS),
диапазон IP-адресов (с маской через слэш) или одиночный IP-адрес.
<i>Маской</i>

может быть сетевая маска или число, соответствующее количеству определяющих
разрядов в сетевой маске.
Например, маска 
<i>24</i>

эквивалентна 
<i>255.255.255.0</i>.

Знак "!" перед спецификацией адреса инвертирует результат теста.
Опция
<b>--src</b>

является псевдонимом данного параметра.
</dd><dt><b>-d, --destination </b>[!] <i>адрес</i>[/<i>маска</i>]

</dt><dd>
Адрес цели. Синтаксис аналогичен синтаксису параметра 
<b>-s</b>

Опция 
<b>--dst</b>

является псевдонимом данного параметра.
</dd><dt><b>-j, --jump </b><i>цель</i>

</dt><dd>
Определяет цель правила; т.е., что делать, когда пакет попадает под условия
правила.
Целью может быть цепочка, определённая пользователем (отличная от цепочки
правила),
одна из встроенных целей, определяющая окончательное действие над пакетом,
или расширение (см. раздел
<b>РАСШИРЕНИЯ </b>

далее по тексту). Если эта опция не задана в правиле (и ключ
<b>-g</b>

также не использован), то правило не будет применяться, но счётчик количества
применений правила будет увеличен.
</dd><dt><b>-g, --goto </b><i>цепочка</i>

</dt><dd>
Продолжить обработку в цепочке, определённой пользователем.
В отличие от опции --jump, после возврата из вызванной цепочки, применение
правил будет продолжено не в текущей цепочке, а в той цепочке, которая вызвала
текущую через --jump.
</dd><dt><b>-i, --in-interface </b>[!] <i>имя</i>

</dt><dd>
Имя интерфейса, через который должен быть получен обрабатываемый пакет
(только для пакетов входящих в цепочки 
<b>INPUT</b>,

<b>FORWARD</b>

и 
<b>PREROUTING ).</b>

Использование аргумента "!" перед именем интерфейса инвертирует результат
теста.
Если имя интерфейса оканчивается на "+", то это означает любой интерфейс, имя
которого начинается с указанного имени.
Если эта опция опущена, при обработке пакета интерфейс, с которого он был
получен, не учитывается.
</dd><dt><b>-o, --out-interface </b>[!] <i>имя</i>

</dt><dd>
Имя интерфейса, через который отправляется обрабатываемый пакет
(только для пакетов входящих в цепочки 
<b>FORWARD</b>,

<b>OUTPUT</b>

и 
<b>POSTROUTING ).</b>

Использование аргумента "!" перед именем интерфейса инвертирует результат теста.
Если имя интерфейса оканчивается на "+", то это означает любой интерфейс, имя
которого начинается с указанного имени.
Если эта опция опущена, при обработке пакета интерфейс, с которого он был
получен, не учитывается.
</dd><dt><b>[!]  -f, --fragment</b>

</dt><dd>
Означает, что это правило будет применяться ко второму и последующим фрагментам
фрагментированного пакета.
Так как у фрагмента невозможно определить номер порта источника или цели,
равно как и тип ICMP, такие пакеты не обрабатываются правилами, содержащими
номера портов или тип ICMP.
Если перед флагом -f указан "!", то правило будет применяться только к первому
фрагменту или к нефрагментированному пакету.
</dd><dt><b>-c, --set-counters </b><i>число-пакетов число-байт</i>

</dt><dd>
Позволяет инициализировать в правиле счётчики пакетов и байтов (при выполнении
операций
<b>INSERT,</b>

<b>APPEND,</b>

<b>REPLACE ).</b>

</dd></dl>
<a name="lbAJ">&nbsp;</a>
<h3>ПРОЧИЕ ОПЦИИ</h3>

Имеются следующие дополнительные опции:
<dl compact="">
<dt><b>-v, --verbose</b>

</dt><dd>
Увеличить подробность сообщений.
При указании её с командой list будет выводиться имя интерфейса,
параметры правил и маски TOS.
Также выводятся счётчики ("K", "M", "G" соответствуют множителям
1000, 1 000 000 и 1 000 000 000; см.
<b>-x ).</b>

Если ключ используется с командами --append, --insert, --delete или --replace,
то будет выведен подробный отчёт о произведенной операции.
</dd><dt><b>-n, --numeric</b>

</dt><dd>
Выводить IP-адреса и номера портов в числовом виде предотвращая попытки
преобразовать их в символические имена.
</dd><dt><b>-x, --exact</b>

</dt><dd>
Для всех чисел в выходных данных выводить их точные значения без округления
и без использования множителей K, M, G.
Этот ключ используется только с командой 
<b>-L</b>

и не применим с другими командами.
</dd><dt><b>--line-numbers</b>

</dt><dd>
Режим вывода номеров строк при отображении списка правил командой --list.
Номер строки соответствует позиции правила в цепочке.
</dd><dt><b>--modprobe=команда</b>

</dt><dd>
Команда загрузки модулей ядра (при добавлении правил в цепочку).
Может использоваться в случае, когда модули ядра находится вне стандартного пути
поиска.
</dd></dl>
<a name="lbAK">&nbsp;</a>
<h2>РАСШИРЕНИЯ МЕХАНИЗМА ТЕСТИРОВАНИЯ</h2>

Возможности тестирования пакетов расширяются через модули.
Последние загружаются либо автоматически при указании
<b>-p</b>

/
<b>--protocol ,</b>

либо явно при указании имени модуля через
<b>-m</b>

/
<b>--match .</b>

После загрузки модуля становятся доступными дополнительные опции командной
строки, в зависимости от модуля.
Справку по новым ключам можно получить с помощью ключа
<b>-h</b>

/
<b>--help .</b>

Допустимо указание нескольких модулей.
Результаты тестирования, выдаваемые модулем, обычно можно инвертировать указав 
<b>!</b>

перед его именем.
В базовую поставку входят следующие модули.

<a name="lbAL">&nbsp;</a>
<h3>account</h3>

Вести учёт трафика для всех хостов в определённой подсети (по маске).
<p>
Возможности:
</p><p>
- подробная (один счётчик на протокол - TCP/UDP/IMCP/Прочие) и краткая
статистика
</p><p>
- одно правило iptables для всех хостов в определённой подсети (по маске).
</p><p>
- загрузка/сохранение счётчиков (посредством записей procfs)
</p><p>
</p><dl compact="">
<dt><b>--aaddr </b><i>сеть/маска</i>

</dt><dd>
Подсеть, для которой следует вести статистику.
</dd><dt><b>--aname </b><i>имя</i>

</dt><dd>
Имя таблицы для данной статистики. По умолчанию - DEFAULT.
</dd><dt><b>--ashort</b>

</dt><dd>
Не разделять учёт по протоколам.

Пример использования:
<p>
Вести учёт трафика из/в сеть 192.168.0.0/24 в таблице mynetwork:
</p><p>
# iptables -A FORWARD -m account --aname mynetwork --aaddr 192.168.0.0/24
</p><p>
Вести учёт трафика WWW-сервера из/в сеть 192.168.0.0/24 в таблице mywwwserver:
</p><p>
# iptables -A INPUT -p tcp --dport 80
<br>&nbsp;&nbsp;-m&nbsp;account&nbsp;--aname&nbsp;mywwwserver&nbsp;--aaddr&nbsp;192.168.0.0/24&nbsp;--ashort
</p><p>
# iptables -A OUTPUT -p tcp --sport 80
<br>&nbsp;&nbsp;-m&nbsp;account&nbsp;--aname&nbsp;mywwwserver&nbsp;--aaddr&nbsp;192.168.0.0/24&nbsp;--ashort
</p><p>
Снять показания счётчиков:
</p><p>
# cat /proc/net/ipt_account/mynetwork
# cat /proc/net/ipt_account/mywwwserver
</p><p>
Установить показания счётчиков:
</p><p>
# echo "ip = 192.168.0.1 packets_src = 0" &gt; /proc/net/ipt_account/mywwserver
</p><p>
Веб-страница:
<br>&nbsp;&nbsp;<a href="http://www.barbara.eu.org/~quaker/ipt_account/">http://www.barbara.eu.org/~quaker/ipt_account/</a>
</p></dd></dl>
<a name="lbAM">&nbsp;</a>
<h3>addrtype</h3>

Данный модуль тестирует пакеты по 
<b>типу адреса.</b>

Точное определение конкретного "типа адреса" зависит от соответствующего
протокола третьего уровня.
<dl compact="">
<dt>Имеются следующие типы адресов:</dt><dd>
</dd><dt><b>UNSPEC</b>

</dt><dd>
неопределённый адрес (0.0.0.0)
<b>UNICAST</b>

адрес для конкретного устройства
<b>LOCAL</b>

локальный адрес
<b>BROADCAST</b>

широковещательный адрес
<b>ANYCAST</b>

адрес для любого устройства
<b>MULTICAST</b>

адрес для нескольких устройств
<b>BLACKHOLE</b>

адрес "в никуда"
<b>UNREACHABLE</b>

недоступный адрес
<b>PROHIBIT</b>

запрещённый адрес
<b>THROW</b>

не описан
<b>NAT</b>

не описан
<b>XRESOLVE</b>

не описан
</dd><dt><b>--src-type </b><i>тип</i>

</dt><dd>
Исходный адрес должен иметь указанный тип
</dd><dt><b>--dst-type </b><i>тип</i>

</dt><dd>
Целевой адрес должен иметь указанный тип
</dd></dl>
<a name="lbAN">&nbsp;</a>
<h3>ah</h3>

Этот модуль тестирует по последовательным периферийным интерфейсам (SPI)
в аутентификационном заголовке пакетов IPsec.
<dl compact="">
<dt><b>--ahspi </b>[!] <i>spi</i>[:<i>spi</i>]

</dt><dd>
</dd></dl>
<a name="lbAO">&nbsp;</a>
<h3>childlevel</h3>

Экспериментальный модуль. Он тестирует по факту принадлежности пакета 
к основному соединению непосредственно или через дочерние соединения.
Например, большинство пакетов принадлежат к основному соединению непосредственно
(уровень 0).
Данные FTP - дочернему (уровень 1). Уровень может быть сколь угодно большим.
<dl compact="">
<dt><b>--childlevel </b>[!] <i>уровень</i>

</dt><dd>
</dd></dl>
<a name="lbAP">&nbsp;</a>
<h3>comment</h3>

Позволяет добавлять комментарии (до 256 символов) в правила.
<dl compact="">
<dt><b>--comment </b><i>комментарий</i>

</dt><dd>
</dd><dt>Пример:</dt><dd>
iptables -A INPUT -s 192.168.0.0/16 -m comment --comment "A privatized IP block"
</dd></dl>
<a name="lbAQ">&nbsp;</a>
<h3>condition</h3>

Результат теста совпадает со значением в соответствующем файле /proc - 0 или 1.
<dl compact="">
<dt><b>--condition </b><i>[!] имя-файла</i>

</dt><dd>
Выдать результат теста из /proc/net/ipt_condition/имя-файла
</dd></dl>
<a name="lbAR">&nbsp;</a>
<h3>connbytes</h3>

Результат теста будет зависеть от количества байт или пакетов,
переданных на данный момент (в обоих или одном из направлений), или
по среднему числу байт, приходящихся на пакет.
<p>
Под каждый из счётчиков отводится 64 бита, поэтому их переполнение
практически невозможно.
</p><p>
Обычно данный модуль используется для уменьшения приоритета долгих загрузок.
</p><p>
Статистику по трафику соединений можно просмотреть в файле 
/proc/net/ip_conntrack, для обращения к ней воспользуйтесь ctnetlink
</p><dl compact="">
<dt>[<b>!</b>]<b> --connbytes </b><i>мин</i><b>:</b>[<i>макс</i>]</dt><dd>
Результат теста будет положительным для пакетов соединения 
через которое принято пакетов/байтов больше первого числа,
и меньше второго (если оно указано). Также первое число может выступать нижней
границей для среднего размера пакета.
"!" инвертирует результат.
</dd><dt><b>--connbytes-dir</b> [<b>original</b>|<b>reply</b>|<b>both</b>]</dt><dd>
Какие пакеты учитывать (свои, ответные или все)
</dd><dt><b>--connbytes-mode</b> [<b>packets</b>|<b>bytes</b>|<b>avgpkt</b>]</dt><dd>
Отслеживаемый показатель - число пакетов, байтов или средний размер всех
полученных пакетов (в байтах).
Если в предыдущей опции указано both, а в данной - avgpkt, и 
данные передаются (преимущественно) в одном направлении
(например, HTTP), средний размер пакета будет приблизительно в два раза меньше
размера пакетов несущих данные.
</dd><dt>Пример:</dt><dd>
iptables .. -m connbytes --connbytes 10000:100000 --connbytes-dir both
--connbytes-mode bytes ...
</dd></dl>
<a name="lbAS">&nbsp;</a>
<h3>connlimit</h3>

Позволяет ограничить число одновременных соединений TCP для одного
IP-адреса (клиента) либо блока адресов.
<dl compact="">
<dt>[<b>!</b>] <b>--connlimit-above </b><i>n</i></dt><dd>
Выдавать положительный результат если число tcp-соединений (не) больше n
</dd><dt><b>--connlimit-mask </b><i>биты</i>

</dt><dd>
Группировать хосты по указанной маске

Примеры:
</dd><dt># допускать не больше 2 соединений telnet с одного хоста</dt><dd>
iptables -A INPUT -p tcp --syn --dport 23 -m connlimit --connlimit-above 2 -j
REJECT
</dd><dt># то же самое:</dt><dd>
iptables -A INPUT -p tcp --syn --dport 23 -m connlimit ! --connlimit-above 2 -j
ACCEPT
</dd><dt># ограничить число одновременных запросов http до 16 на подсеть класса C (24</dt><dd>
первых разряда)
iptables -p tcp --syn --dport 80 -m connlimit --connlimit-above 16
--connlimit-mask 24 -j REJECT
</dd></dl>
<a name="lbAT">&nbsp;</a>
<h3>connmark</h3>

Этот модуль позволяет использовать в правилах проверку значений маркеров
соединения, установленных с помощью операции (цели)
<b>CONNMARK</b>

(см. ниже).
<dl compact="">
<dt><b>--mark </b><i>маркер[/маска]</i>

</dt><dd>
Значение маркера соединения, при котором выполняется условие.
Если указана маска, она накладывается (операция поразрядного И) на значение
маркера соединения перед проверкой условия.
</dd></dl>
<a name="lbAU">&nbsp;</a>
<h3>connrate</h3>

Выдаёт результат теста на основе текущей скорости передачи данных по соединению.
<dl compact="">
<dt><b>--connrate </b><i>[!] [мин</i>]:[<i>макс</i>]

</dt><dd>
Выдавать положительный результат если текущая скорость находится в указанных
рамках.
Указание "!" перед аргументом обращает смысл последнего.
</dd></dl>
<a name="lbAV">&nbsp;</a>
<h3>conntrack</h3>

Этот модуль при использовании совместно с компонентом мониторинга соединений
предоставляет более широкие сведения о состоянии соединения, чем "state".
Модуль доступен если сборка iptables проводилась с ядром, имеющим возможности
требуемые для модуля.
<dl compact="">
<dt><b>--ctstate </b><i>состояния</i>

</dt><dd>
Список состояний соединения через запятую, при которых результат будет
положительным.
Возможные состояния:
<b>INVALID</b>

- пакет не связан с каким-либо известным соединением,
<b>ESTABLISHED</b>

- пакет связан с соединением, по которому уже проходили пакеты в обоих
направлениях,
<b>NEW</b>

- пакет инициирует новое соединение, либо связан с соединением, по которому
ещё не проходили пакеты в обоих направлениях ,
<b>RELATED</b>

- пакет инициирует новое соединение, но также связан с 
уже существующим соединением, например при передаче данных по FTP
или сообщении об ошибке ICMP,
<b>SNAT</b>

- виртуальное состояние, положительный результат выдаётся если исходный адрес
источника
отличен от адреса, который должен получить ответ,
<b>DNAT</b>

- виртуальное состояние, положительный результат выдаётся если исходный адрес
получателя
отличен от адреса отправителя ответа,
</dd><dt><b>--ctproto </b><i>протокол</i>

</dt><dd>
Проверяет принадлежность пакета к протоколу, указанному номером или символьным
именем.
</dd><dt><b>--ctorigsrc </b><i>[!] адрес</i>[/<i>маска</i>]

</dt><dd>
Проверяет соответствие исходного (нетранслированного) адреса отправителя
указанному адресу или диапазону адресов.
</dd><dt><b>--ctorigdst </b><i>[!] адрес</i>[/<i>маска</i>]

</dt><dd>
Проверяет соответствие исходного (нетранслированного) адреса получателя
указанному адресу или диапазону адресов.
</dd><dt><b>--ctreplsrc </b><i>[!] адрес</i>[/<i>маска</i>]

</dt><dd>
Проверяет соответствие адреса отправителя отклика указанному адресу или
диапазону адресов.
</dd><dt><b>--ctrepldst </b><i>[!] fIадрес</i><b>[/</b><i>маска</i>]

</dt><dd>
Проверяет соответствие адреса получателя отклика указанному адресу или диапазону
адресов.
</dd><dt><b>--ctstatus </b><i>[NONE|EXPECTED|SEEN_REPLY|ASSURED</i>][,...]

</dt><dd>
Проверяет соответствие пакета одному или группе внутренних состояний conntrack.
</dd><dt><b>--ctexpire </b><i>time</i>[<i>:time</i>]

</dt><dd>
Проверяет соответствие оставшегося для пакета времени жизни заданному значению
или диапазону.
</dd></dl>
<a name="lbAW">&nbsp;</a>
<h3>dccp</h3>

<dl compact="">
<dt><b>--source-port</b>,<b>--sport </b>[<b>!</b>] <i>порт</i>[<b>:</b><i>порт</i>]</dt><dd>
</dd><dt><b>--destination-port</b>,<b>--dport </b>[<b>!</b>] <i>порт</i>[<b>:</b><i>порт</i>]</dt><dd>
</dd><dt><b>--dccp-types</b> [<b>!</b>] <i>типы-пакетов</i></dt><dd>
Тип пакета DCCP должен быть одним из перечисленных (через запятую)
Возможные типы: 
<b>REQUEST RESPONSE DATA ACK DATAACK CLOSEREQ CLOSE RESET SYNC SYNCACK</b>

INVALID" .
</dd><dt><b>--dccp-option</b> [<b>!</b>] <i>число</i></dt><dd>
Для положительного результата должна быть установлена опция DCP.
</dd></dl>
<a name="lbAX">&nbsp;</a>
<h3>dscp</h3>

Этот модуль проверяет 6-разрядное значение DSCP в поле TOS заголовка IP.
В соответствии с RFC 247413 значение DSCP заменяет собой значение TOS.
<dl compact="">
<dt><b>--dscp </b><i>значение</i>

</dt><dd>
Значение в десятичной или шестнадцатеричной форме (0-32).
</dd><dt><b>--dscp-class </b><i>класс-DiffServ</i>

</dt><dd>
Класс DiffServ. Возможные значения: BE, EF, AFxx, CSx.
</dd></dl>
<a name="lbAY">&nbsp;</a>
<h3>dstlimit</h3>

Позволяет ограничивать скорость обмена пакетами в секунду (pps) 
для одного целевого IP/порта.
<dl compact="">
<dt>ЭТОТ МОДУЛЬ УСТАРЕЛ. ИСПОЛЬЗУЙТЕ МОДУЛЬ "hashlimit"</dt><dd>
</dd><dt><b>--dstlimit </b><i>скорость</i>

</dt><dd>
Ограничение на среднюю скорость обмена пакетами. Допустимо дополнение в конце
/sec /minute /hour /day.
</dd><dt><b>--dstlimit-mode </b><i>режим</i>

</dt><dd>
Режим ограничения: это один из наборов
<b>dstip + dstip-dstport ,</b>

<b>srcip-dstip ,</b>

либо
<b>srcipdstip-dstport .</b>

</dd><dt><b>--dstlimit-name </b><i>имя</i>

</dt><dd>
Имя файла /proc/net/ipt_dstlimit/*
</dd><dt><b>[</b><i>--dstlimit-burst </i><b>burst</b><i>]</i>

</dt><dd>
Число пакетов в пике, для которых будет результат теста будет
положительным.
Значение по умолчанию: 5
</dd><dt><b>[</b><i>--dstlimit-htable-size </i><b>размер</b><i>]</i>

</dt><dd>
Число наборов (buckets) в хэш-таблице
</dd><dt><b>[</b><i>--dstlimit-htable-max </i><b>максимум</b><i>]</i>

</dt><dd>
Ограничение на число элементов в хэш-таблице
</dd><dt><b>[</b><i>--dstlimit-htable-gcinterval </i><b>интервал</b><i>]</i>

</dt><dd>
Интервал между сбором мусора в хэш-таблице (в мс).
Значение по умолчанию - 1000 (1 секунда).
</dd><dt><b>[</b><i>--dstlimit-htable-expire </i><b>время</b>

</dt><dd>
Время после которого неиспользуемые элементы подлежат удалению, в мс.
Значение по умолчанию - 10000 (10 секунд).
</dd></dl>
<a name="lbAZ">&nbsp;</a>
<h3>ecn</h3>

Используется для проверки соответствия значения поля ECN в заголовках IPv4 и
TCP.
ECN - это механизм явного предуведомления о перегрузке (Explicit Congestion
Notification) определённый RFC3168
<dl compact="">
<dt><b>--ecn-tcp-cwr</b>

</dt><dd>
Результат определяется разрядом TCP ECN CWR (Congestion Window Received).
</dd><dt><b>--ecn-tcp-ece</b>

</dt><dd>
Результат определяется разрядом TCP ECN ECE (ECN Echo).
</dd><dt><b>--ecn-ip-ect </b><i>num</i>

</dt><dd>
IPv4 ECT (ECN-Capable Transport) должен быть равным указанному числу (от `0' до
`3').
</dd></dl>
<a name="lbBA">&nbsp;</a>
<h3>esp</h3>

Модуль esp служит для проверки значений SPI в заголовках ESP пакетов IPSec.
<dl compact="">
<dt><b>--espspi </b>[!] <i>spi</i>[:<i>spi</i>]

</dt><dd>
</dd></dl>
<a name="lbBB">&nbsp;</a>
<h3>fuzzy</h3>

Результат теста зависит от скорости доставки пакетов по методу FLC (Fuzzy Logic
Controller):
пока скорость доставки пакетов не достигает нижнего порога, условие никогда не
будет выполняться; 
при скорости в диапазоне между нижним и верхним порогами частота выполнения
условий будет расти пропорционально скорости доставки пакетов;
после превышения верхнего порога скорости частота выполнения условий достигнет
максимального значения.
<dl compact="">
<dt><b>--lower-limit </b><i>скорость</i>

</dt><dd>
Нижний порог (пакетов в секунду).
</dd><dt><b>--upper-limit </b><i>скорость</i>

</dt><dd>
Верхний порог (пакетов в секунду).
</dd></dl>
<a name="lbBC">&nbsp;</a>
<h3>hashlimit</h3>

Этот модуль добавляет новое условие проверки hashlimit,
позволяющее вводить ограничения на один адрес назначения или пару "адрес-порт".
<p>
С помощью данного условия можно задавать ограничения типа 
</p><p>
</p><dl compact="">
<dt></dt><dd>
<br>&nbsp;"не&nbsp;более&nbsp;1000&nbsp;пакетов&nbsp;в&nbsp;секунду&nbsp;для&nbsp;каждого&nbsp;хоста&nbsp;в&nbsp;сети&nbsp;192.168.0.0/16"
</dd><dt></dt><dd>
<br>&nbsp;"не&nbsp;более&nbsp;100&nbsp;пакетов&nbsp;в&nbsp;секунду&nbsp;для&nbsp;каждого&nbsp;сервиса&nbsp;на&nbsp;хосте&nbsp;192.168.1.1"

одним правилом iptables.
</dd><dt><b>--hashlimit </b><i>скорость</i>

</dt><dd>
Среднее значение скорости.
Параметр представляет собой целое число, определяющее максимальное количество
пакетов, и суффикс, который определяет единицу времени.
В качестве суффикса могут использоваться значения /second, /minute, /hour, /day.
По умолчанию подразумевается число пакетов в секунду.
</dd><dt><b>--hashlimit-burst </b><i>число</i>

</dt><dd>
Число пакетов в пике
</dd><dt><b>--hashlimit-mode </b><i>destip | destip-destport</i>

</dt><dd>
Ограничение по адресам или портам.
</dd><dt><b>--hashlimit-name </b><i>foo</i>

</dt><dd>
Имя для /proc/net/ipt_hashlimit/foo.
</dd><dt><b>--hashlimit-htable-size </b><i>num</i>

</dt><dd>
Число элементов (buckets) в хэш-таблице.
</dd><dt><b>--hashlimit-htable-max </b><i>num</i>

</dt><dd>
Максимальное количество записей в хэше.
</dd><dt><b>--hashlimit-htable-expire </b><i>num</i>

</dt><dd>
Время (в миллисекундах) жизни записи в хэш-таблице. По умолчанию время жизни
составляет 10000 (10 секунд).
</dd><dt><b>--hashlimit-htable-gcinterval </b><i>num</i>

</dt><dd>
Интервал "сборки мусора" в хэш-таблице.
</dd></dl>
<a name="lbBD">&nbsp;</a>
<h3>helper</h3>

Выдаёт положительный результат для пакетов относящихся к конкретному
вспомогательному компоненту conntrack.
<dl compact="">
<dt><b>--helper </b><i>имя</i>

</dt><dd>
Вспомогательный компонент conntrack.
<dl compact=""><dt></dt><dd>
<p>

Может принимать значение "ftp" для пакетов ftp-сеанса на стандартном порте.
В случае нестандартных портов добавляйте их к имени: "ftp-2121".
</p><p>

Аналогично и для других компонентов.
</p></dd></dl>

</dd></dl>
<a name="lbBE">&nbsp;</a>
<h3>icmp</h3>

Эта расширение загружается при указании `--protocol icmp'.
<dl compact="">
<dt><b>--icmp-type </b>[!] <i>тип</i>

</dt><dd>
Тип ICMP в виде числа или имени в соответствии с 
<pre> iptables -p icmp -h
</pre>

</dd></dl>
<a name="lbBF">&nbsp;</a>
<h3>iprange</h3>

Результат теста зависит от адреса IPv4.
<dl compact="">
<dt><b>[!]</b><i>--src-range </i><b>ip-ip</b>

</dt><dd>
Диапазон IP-адресов отправителя.
</dd><dt><b>[!]</b><i>--dst-range </i><b>ip-ip</b>

</dt><dd>
Диапазон IP-адресов получателя.
</dd></dl>
<a name="lbBG">&nbsp;</a>
<h3>ipv4options</h3>

Результат теста зависит от параметров заголовка IPv4, таких как 
параметры маршрутизации, запись маршрута, запрос времени, оповещение
маршрутизатора.
<dl compact="">
<dt><b>--ssrr</b>

</dt><dd>
Должен быть установлен флаг strict source routing (маршрутизация указывается
источником).
</dd><dt><b>--lsrr</b>

</dt><dd>
Должен присутствовать флаг loose source routing (свободная маршрутизация).
</dd><dt><b>--no-srr</b>

</dt><dd>
Флаг, позволяющий источнику определить режим маршрутизации, должен
отсутствовать.
</dd><dt><b></b>[<b>!</b>]<b> --rr</b>

</dt><dd>
Должен присутствовать флаг RR (route record).
</dd><dt><b></b>[<b>!</b>]<b> --ts</b>

</dt><dd>
Должен присутствовать флаг TS (timestamp).
</dd><dt><b></b>[<b>!</b>]<b> --ra</b>

</dt><dd>
Должен присутствовать флаг оповещения маршрутизатора (router-alert).
</dd><dt><b></b>[<b>!</b>]<b> --any-opt</b>

</dt><dd>
Выдавать положительный результат если хотя бы один пункт из указанных выше был
выполнен.
Если указан !, ни одно из условий не должно выполняться.
</dd><dt>Примеры:</dt><dd>
</dd><dt>$ iptables -A input -m ipv4options --rr -j DROP</dt><dd>
отбрасывать пакеты с флагом record-route.
</dd><dt>$ iptables -A input -m ipv4options --ts -j DROP</dt><dd>
отбрасывать пакеты с флагом timestamp.
</dd></dl>
<a name="lbBH">&nbsp;</a>
<h3>length</h3>

Позволяет проверять размеры пакетов (точно или по диапазону).
<dl compact="">
<dt><b>--length </b>[!] <i>размер</i>[:<i>размер</i>]

</dt><dd>
</dd></dl>
<a name="lbBI">&nbsp;</a>
<h3>limit</h3>

Этот модуль выдаёт положительный результат с фиксированной частотой.
Правило использующее это расширение будет выполняться до момента достижения
лимита
(и наоборот, если указан "!").
Может использоваться вместе с целью
<b>LOG</b>

для получения ограниченного протоколирования.
<dl compact="">
<dt><b>--limit </b><i>частота</i>

</dt><dd>
Максимальная средняя частота положительных результатов.
После числа можно указывать единицы:
`/second', `/minute', `/hour', `/day'; значение по умолчанию - 
3/hour.
</dd><dt><b>--limit-burst </b><i>number</i>

</dt><dd>
Ограничение на исходное число пропускаемых пакетов:
это число увеличивается на единицу каждый раз когда ограничение на частоту
положительных результатов не достигается.
Это происходит столько раз, сколько указано в данном параметре.
Значение по умолчанию - 5.
</dd></dl>
<a name="lbBJ">&nbsp;</a>
<h3>mac</h3>

<dl compact="">
<dt><b>--mac-source </b>[!] <i>адрес</i>

</dt><dd>
Выполнять тестирование по MAC-адресу отправителя.
Адрес должен указываться в форме XX:XX:XX:XX:XX:XX.
Использование данного условия имеет смысл только при получении пакетов от
устройства Ethernet, проходящих на одну из цепочек
<b>PREROUTING</b>,

<b>FORWARD</b>

или
<b>INPUT .</b>

</dd></dl>
<a name="lbBK">&nbsp;</a>
<h3>mark</h3>

Тестирует по полю mark. Это специальное поле, которое существует только в
области памяти ядра и связывается с конкретным пакетом.
(для установки этого поля используется цель
<b>MARK ,</b>

описанная ниже).
<dl compact="">
<dt><b>--mark </b><i>число</i>[/<i>маска</i>]

</dt><dd>
Пропускать пакеты с указанной отметкой (представляющей собой беззнаковое целое)
Если указана <i>маска</i>, то перед сравнением она накладывается на указанное
значение (логическое И).
</dd></dl>
<a name="lbBL">&nbsp;</a>
<h3>mport</h3>

Модуль пропускает пакеты на заданном наборе портов (исходных или целевых).
Возможно указание до 15 портов. Используется только вместе с 
<b>-p tcp</b>

или 
<b>-p udp</b>.

<dl compact="">
<dt><b>--source-ports </b><i>порт</i>[,<i>порт</i>[,<i>порт</i>...]]

</dt><dd>
Пропускать пакеты с исходным портом равным одному из указанных.
Краткая форма ключа -
<b>--sports .</b>

</dd><dt><b>--destination-ports </b><i>порт</i>[,<i>порт</i>[,<i>порт</i>...]]

</dt><dd>
Пропускать пакеты с портом назначения равным одному из указанных.
Краткая форма ключа -
<b>--dports .</b>

</dd><dt><b>--ports </b><i>порт</i>[,<i>порт</i>[,<i>порт</i>...]]

</dt><dd>
Пропускать пакеты с одинаковыми исходным и портом назначения и равными одному из
указанных.
</dd></dl>
<a name="lbBM">&nbsp;</a>
<h3>multiport</h3>

Позволяет указывать в тексте правила несколько (до 15) портов и диапазонов
портов.
Диапазон портов (порт:порт) считается за два порта (в отношении ограничения в
15).
Используется только вместе с 
<b>-p tcp</b>

или
<b>-p udp</b>.

<dl compact="">
<dt><b>--source-ports </b><i>[!] порт</i>[,<i>порт</i>[,<i>порт:порт</i>...]]

</dt><dd>
Пропускать пакеты с исходным портом равным одному из указанных.
Краткая форма ключа -
<b>--sports .</b>

</dd><dt><b>--destination-ports </b><i>[!] порт</i>[,<i>порт</i>[,<i>порт:порт</i>...]]

</dt><dd>
Пропускать пакеты с портом назначения равным одному из указанных.
Краткая форма ключа -
<b>--dports .</b>

</dd><dt><b>--ports </b><i>[!] порт</i>[,<i>порт</i>[,<i>порт:порт</i>...]]

</dt><dd>
Пропускать пакеты с одинаковыми исходным и портом назначения и равными одному из
указанных.
</dd></dl>
<a name="lbBN">&nbsp;</a>
<h3>nth</h3>

Пропускает каждый `n'-ый пакет
<dl compact="">
<dt><b>--every </b><i>n</i>

</dt><dd>
Пропускать каждый n-ый пакет.
</dd><dt><b>[</b><i>--counter </i><b>номер</b><i>]</i>

</dt><dd>
Использовать внутренний счётчик с указанным номером. Значение по умолчанию -
`0'.
</dd><dt><b>[</b><i>--start </i><b>число</b><i>]</i>

</dt><dd>
Начальное значение счётчика (вместо стандартного `0').
Обычно между `0' и `n'-1.
</dd><dt><b>[</b><i>--packet </i><b>k</b><i>]</i>

</dt><dd>
Пропускать k-ый пакет из набора n пакетов. Соответственно, значение должно быть
между `0' и `n'-1.
</dd></dl>
<a name="lbBO">&nbsp;</a>
<h3>osf</h3>

Идея фильтрации по пассивным сигнатурам ОС (passive OS fingerprint)
была изначально реализована в брандмауэре pf из OpenBSD.
<p>
Оригинальная таблица сигнатур составлена Михаилом Залевски (Michal Zalewski)
&lt;<a href="mailto:lcamtuf@coredump.cx">lcamtuf@coredump.cx</a>&gt;.
</p><p>
Данный модуль фильтрует пакеты по данным из (первого) пакета SYN
(WS, MSS, опциям и их порядку, ttl, df и т.д.), определяя ОС отправителя на
основе динамической таблицы сигнатур ОС.
</p><dl compact="">
<dt><b>--log 1/0 </b>

</dt><dd>
Записывать в протокол семейства ОС даже если они не совпадают с ожидаемыми.
0 - записывать все данные; 
1 - только первые.
<p>
Данные записываются в syslog в таком формате:
</p></dd><dt></dt><dd>
ipt_osf: Windows [2000:SP3:Windows XP Pro SP1, 2000 SP3]: 11.22.33.55:4024 -&gt;
11.22.33.44:139
</dd><dt></dt><dd>
ipt_osf: Unknown: 16384:106:1:48:020405B401010402 44.33.22.11:1239 -&gt;
11.22.33.44:80
</dd><dt><b>--smart</b>

</dt><dd>
Включить дополнительные алгоритмы определения удалённой ОС.
OSF будет учитывать исходный TTL только если соединение установлено в рамках
локальной сети.
</dd><dt><b>--netlink</b>

</dt><dd>
Протоколировать все события в NETLINK_NFLOG groupt 1.
</dd><dt><b>--genre </b><i>[!] string</i>

</dt><dd>
Пропускать пакеты от семейства ОС.

Пример:
<p>
#iptables -I INPUT -j ACCEPT -p tcp -m osf --genre Linux --log 1 --smart
</p><p>
Обратите внимание, что указание -p tcp обязательно, поскольку проверка
ведётся на уровне этого протокола.
</p><p>
Сигнатуры хранятся в файле /proc/sys/net/ipv4/osf.
Очистить список сигнатур можно командой
</p></dd><dt></dt><dd>
echo -en FLUSH &gt; /proc/sys/net/ipv4/osf

Допустима только одна сигнатура за открытие/запись/закрытие.
<p>
Список сигнатур доступен в Интернете по адресу
<a href="http://www.openbsd.org/cgi-bin/cvsweb/src/etc/pf.os">http://www.openbsd.org/cgi-bin/cvsweb/src/etc/pf.os</a>
</p></dd></dl>
<a name="lbBP">&nbsp;</a>
<h3>owner</h3>

Позволяет фильтровать по параметрам "владельца" пакета.
Этот критерий можно использовать только в цепочке 
<b>OUTPUT ,</b>

но даже в этом случае могут попадаться пакеты без владельца
(например, ответы ISMP ping), и такие пакеты не будут пропускаться.
<dl compact="">
<dt><b>--uid-owner </b><i>идентификатор-пользователя</i>

</dt><dd>
Пропускать пакеты генерируемые процессами работающими от указанного
пользователя.
</dd><dt><b>--gid-owner </b><i>идентификатор-группы</i>

</dt><dd>
Пропускать пакеты генерируемые процессами работающими от пользователя входящего
в указанную группу.
</dd><dt><b>--pid-owner </b><i>идентификатор-процесса</i>

</dt><dd>
Пропускать пакеты генерируемые процессом с указанным идентификатором.
</dd><dt><b>--sid-owner </b><i>идентификатор-сеанса</i>

</dt><dd>
Пропускать пакеты генерируемые процессами в сеансе с указанным идентификатором.
</dd><dt><b>--cmd-owner </b><i>имя-команды</i>

</dt><dd>
Пропускать пакеты генерируемые процессами с указанным именем команды.
(ключ поддерживается только если пакет iptables был собран с ядром, имеющим
соответствующую функцию)
</dd><dt><b>Примечание: фильтрация по pid, sid и команде не работает в SMP-системах</b>

</dt><dd>
</dd></dl>
<a name="lbBQ">&nbsp;</a>
<h3>physdev</h3>

Позволяет организовывать фильтрацию по устройствам используемым для связи двух
локальных сетей.
Это модуль является частью инфраструктуры для IP-брандмауэра "прозрачно"
связывающего сети. Имеет смысл использовать только с ядрами 2.5.44.
<dl compact="">
<dt><b>--physdev-in</b> [!] <i>имя</i>

</dt><dd>
Порт связи сетей, через который получен пакет (только для пакетов, проходящих
цепочки
<b>INPUT</b>,

<b>FORWARD</b>

или
<b>PREROUTING ).</b>

Если имя интерфейса оканчивается на "+", то будут пропускаться пакеты со всех
интерфейсов, имя которых начинается 
с указанной последовательности.
Если пакет получен из устройства, которое не связывает локальные сети,
он не будет пропущен (если только не указано "!").
</dd><dt><b>--physdev-out</b> [!] <i>имя</i>

</dt><dd>
Порт связи сетей, через который пакет отправляется
(для пакетов, проходящих цепочки 
<b>FORWARD</b>,

<b>OUTPUT</b>

или 
<b>POSTROUTING ).</b>

Если имя интерфейса оканчивается на "+", то будут пропускаться пакеты со всех
интерфейсов имя которых начинается 
с указанной последовательности. Тестирование по порту вывода в цепочках
<b>OUTPUT</b>

<b>nat</b> и <b>mangle</b>

невозможно, зато в
<b>filter OUTPUT</b>

- возможно. Если пакет отправляется не через устройство связи двух сетей,
или если отправляющее устройство на данном этапе неизвестно,
то такой пакет не будет пропущен (если только не указан "!").
</dd><dt>[!] <b>--physdev-is-in</b>

</dt><dd>
Пропускать пакеты, полученные через интерфейс связи двух сетей.
</dd><dt>[!] <b>--physdev-is-out</b>

</dt><dd>
Пропускать пакеты, отправляемые через интерфейс связи двух сетей.
</dd><dt>[!] <b>--physdev-is-bridged</b>

</dt><dd>
Пропускать пакеты, для которых не выполняется маршрутизация (т.к. они проходят
через "мост" между сетями)
Имеет смысл только в цепочках FORWARD и POSTROUTING.
</dd></dl>
<a name="lbBR">&nbsp;</a>
<h3>pkttype</h3>

Позволяет фильтровать пакеты по их типу на уровне канала связи.
<dl compact="">
<dt><b>--pkt-type </b><i>[unicast</i>|<i>broadcast</i>|<i>multicast</i>]

</dt><dd>
</dd></dl>
<a name="lbBS">&nbsp;</a>
<h3>policy</h3>

Позволяет фильтровать пакеты по стратегии обработки пакета IPsec.
<dl compact="">
<dt><b>--dir </b><i>in|out</i>

</dt><dd>
Стратегия, по которой следует фильтровать: стратегии извлечения данных из
сообщения или включения (инкапсуляции) оных.
Вариант
<b>in</b>

допустим в цепочках
<b>PREROUTING, INPUT и FORWARD ,</b>

вариант
<b>out</b>

<br>&nbsp;-&nbsp;в&nbsp;цепочках
<b>POSTROUTING, OUTPUT и FORWARD .</b>

</dd><dt><b>--pol </b><i>none|ipsec</i>

</dt><dd>
Должен ли пакет подлежать обработке IPsec.
</dd><dt><b>--strict</b>

</dt><dd>
Пропускать пакеты с хотя бы одним правилом, соответствующим заданной стратегии,
или обязательно со всеми.
</dd><dt><b>--reqid </b><i>id</i>

</dt><dd>
Пропускать пакеты с указанным идентификатором reqid правила стратегии.
Идентификатор указывается с помощью команды 
<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=setkey&amp;category=8">setkey</a>(8) ,</b>

в качестве уровня используется
<b>unique:id .</b>

</dd><dt><b>--spi </b><i>spi</i>

</dt><dd>
Фильтровать пакеты на основе последовательного периферийного интерфейса (SPI)
SA.
</dd><dt><b>--proto </b><i>ah|esp|ipcomp</i>

</dt><dd>
Фильтровать пакеты на основе протокола инкапсуляции.
</dd><dt><b>--mode </b><i>tunnel|transport</i>

</dt><dd>
Фильтровать пакеты на основе режима инкапсуляции.
</dd><dt><b>--tunnel-src </b><i>адрес[/маска]</i>

</dt><dd>
Пропускать пакеты с исходным адресом [пункта] режима tunnel SA, входящим в
указанный диапазон.
Имеет смысл только при --mode tunnel.
</dd><dt><b>--tunnel-dst </b><i>адрес[/маска]</i>

</dt><dd>
Пропускать пакеты с адресом назначения режима tunnel SA, входящим в указанный
диапазон.
Имеет смысл только при --mode tunnel.
</dd><dt><b>--next</b>

</dt><dd>
Начать следующий элемент в спецификации стратегии. 
Может указываться вместе с 
--strict
</dd></dl>
<a name="lbBT">&nbsp;</a>
<h3>psd</h3>

Пытаться обнаружить сканирование портов TCP и UDP.
Реализовано на основе scanlogd из Solar Designer.
<dl compact="">
<dt><b>--psd-weight-threshold </b><i>порог</i>

</dt><dd>
Общий вес (см. ниже) пакетов TCP/UDP за последнее время, приходящих от одного
источника, но на разные порты, при котором можно считать, что это умышленное
сканирование портов.
</dd><dt><b>--psd-delay-threshold </b><i>задержка</i>

</dt><dd>
Максимальная задержка (в сотых секунды) между пакетами приходящими на различные
порты
от одного источника, при которой они будут считаться подпоследовательностью
пакетов при сканировании.
</dd><dt><b>--psd-lo-ports-weight </b><i>вес</i>

</dt><dd>
Вес пакетов, приходящих на привилегированные порты (&lt;=1024).
</dd><dt><b>--psd-hi-ports-weight </b><i>weight</i>

</dt><dd>
Вес пакетов, приходящих на непривилегированные порты.
</dd></dl>
<a name="lbBU">&nbsp;</a>
<h3>quota</h3>

Позволяет квотировать использование сети - уменьшает счётчик байтов на единицу
при обработке каждого пакета.
<dl compact="">
<dt><b>--quota </b><i>размер</i>

</dt><dd>
Квота в байтах.

Примечание: не работает в SMP-системах.
</dd></dl>
<a name="lbBV">&nbsp;</a>
<h3>random</h3>

Вероятностная фильтрация.
<dl compact="">
<dt><b>--average </b><i>доля</i>

</dt><dd>
Пропускать указанную часть пакетов (в процентах).
Значение по умолчанию - 50%.
</dd></dl>
<a name="lbBW">&nbsp;</a>
<h3>realm</h3>

Фильтровать пакеты по области маршрутизации.
Последние используются в сложных конфигурациях сетей, задействующих
динамические протоколы маршрутизации наподобие BGP.
<dl compact="">
<dt><b>--realm </b><i>[!] </i><b>значение[/маска]</b>

</dt><dd>
Пропускать пакеты с указанным номером области (диапазон областей можно указывать
добавлением маски).
Также можно указывать области по имени, в соответствии с /etc/iproute2/rt_realms
(в этом случае указание маски недопустимо).
</dd></dl>
<a name="lbBX">&nbsp;</a>
<h3>recent</h3>

Позволяет динамически составлять списки IP-адресов
и выполнять фильтрацию по ним различными способами.
<p>
Например, можно создать список `badguy', соответствующий компьютерам,
<br>&nbsp;с&nbsp;которых&nbsp;поступали&nbsp;запросы&nbsp;на&nbsp;порт&nbsp;139,&nbsp;и&nbsp;затем&nbsp;отбрасывать&nbsp;все&nbsp;их
любые последующие запросы.
</p><dl compact="">
<dt><b>--name </b><i>имя</i>

</dt><dd>
Список, с которым следует работать. Значение по умолчанию - 'DEFAULT'.
</dd><dt>[<b>!</b>] <b>--set</b></dt><dd>
Добавить адрес источника пакета в список.
Если адрес уже в списке, он будет обновлён.
Этот "критерий" всегда возвращает положительный результат
(либо всегда отрицательный - если указано "!").
</dd><dt>[<b>!</b>] <b>--rcheck</b></dt><dd>
Проверить, имеется ли адрес источника пакета в списке.
</dd><dt>[<b>!</b>] <b>--update</b></dt><dd>
Как и <b>--rcheck</b>, если адрес будет найден, запись о времени последнего его
появления
будет обновлена.
</dd><dt>[<b>!</b>] <b>--remove</b></dt><dd>
Возвращает положительный результат, если адрес источника пакета найден в списке
(в этом случае адрес также удаляется из него).
</dd><dt>[<b>!</b>] <b>--seconds </b><i>интервал</i></dt><dd>
Используется с <b>--rcheck</b> или <b>--update</b>.
Учитывать в списке только адреса, которые появлялись в последние n секунд.
</dd><dt>[<b>!</b>] <b>--hitcount </b><i>количество</i></dt><dd>
Используется с <b>--rcheck</b> или <b>--update</b>.
Учитывать в списке только адреса, которые появлялись указанное количество раз
(или больше).
Для ещё большего сужения критерия воспользуйтесь также
<b>--seconds</b>.
</dd><dt><b>--rttl</b></dt><dd>
Используется с <b>--rcheck</b> или <b>--update</b>.
Пропускать пакеты, только если их источник в списке,
и их TTL совпадает с TTL пакета, который привёл к добавлению источника в список
(<b>--set</b>).
Может быть полезно для предотвращения DoS-атак посредством подмены исходного
адреса
(т.е. когда модуль будет блокировать "невиновные" адреса).

Примеры:
</dd><dt></dt><dd>
# iptables -A FORWARD -m recent --name badguy --rcheck --seconds 60 -j DROP
<p>
# iptables -A FORWARD -p tcp -i eth0 --dport 139 -m recent --name badguy --set
-j DROP

Дополнительные примеры приведены на сайте
<a href="http://snowman.net/projects/ipt_recent/.">http://snowman.net/projects/ipt_recent/.</a>
</p><p>
Таблицы адресов хранятся в /proc/net/ipt_recent/.
</p><p>
Таким образом, можно просмотреть текущее содержимое списков адресов,
а также модифицировать их:
</p></dd><dt>echo xx.xx.xx.xx &gt; /proc/net/ipt_recent/DEFAULT</dt><dd>
для добавления адреса в список по умолчанию
</dd><dt>echo -xx.xx.xx.xx &gt; /proc/net/ipt_recent/DEFAULT</dt><dd>
для удаления адреса из списка по умолчанию
</dd><dt>echo clear &gt; /proc/net/ipt_recent/DEFAULT</dt><dd>
для очистки списка по умолчанию.

Параметры модуля (со значениями по умолчанию):
</dd><dt><b>ip_list_tot=</b><i>100</i>

</dt><dd>
Ограничение на количество адресов в одной таблице
</dd><dt><b>ip_pkt_list_tot=</b><i>20</i>

</dt><dd>
Ограничение на количество пакетов для одного адреса, сведения о которых
запоминаются
</dd><dt><b>ip_list_hash_size=</b><i>0</i>

</dt><dd>
Размер хэш-таблицы. 0 - вычислять размер на основе ip_list_tot, при значениях по
умолчанию это 512
</dd><dt><b>ip_list_perms=</b><i>0644</i>

</dt><dd>
Права доступа для файлов /proc/net/ipt_recent/*
</dd><dt><b>debug=</b><i>0</i>

</dt><dd>
Установите в 1 для получения отладочной информации
</dd></dl>
<a name="lbBY">&nbsp;</a>
<h3>sctp</h3>

<dl compact="">
<dt><b>--source-port</b>,<b>--sport </b>[<b>!</b>] <i>порт</i>[<b>:</b><i>порт</i>]</dt><dd>
</dd><dt><b>--destination-port</b>,<b>--dport </b>[<b>!</b>] <i>порт</i>[<b>:</b><i>порт</i>]</dt><dd>
</dd><dt><b>--chunk-types</b> [<b>!</b>] <b>all</b>|<b>any</b>|<b>only</b></dt><dd><b>
</b><i>тип-части</i>[<b>:</b><i>флаги</i>] [...]
Если буква отвечающая флагу указана в верхнем регистре, то положительный
результат будет выдаваться если он установлен, и наоборот.
<p>
Типы частей: DATA INIT INIT_ACK SACK HEARTBEAT HEARTBEAT_ACK ABORT SHUTDOWN
SHUTDOWN_ACK ERROR COOKIE_ECHO COOKIE_ACK ECN_ECNE ECN_CWR SHUTDOWN_COMPLETE
ASCONF ASCONF_ACK
</p><p>
тип части             доступные флаги     
<br>

DATA                  U B E u b e         
<br>

ABORT                 T t                 
<br>

SHUTDOWN_COMPLETE     T t                 
</p><p>
(нижний регистр = флаг должен быть "выключен", верхний - "включен")

Примеры:
</p><p>
iptables -A INPUT -p sctp --dport 80 -j DROP
</p><p>
iptables -A INPUT -p sctp --chunk-types any DATA,INIT -j DROP
</p><p>
iptables -A INPUT -p sctp --chunk-types any DATA:Be -j ACCEPT
</p></dd></dl>
<a name="lbBZ">&nbsp;</a>
<h3>set</h3>

Фильтрует по принадлежности IP множествам определяемым с помощью <a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=ipset&amp;category=8">ipset</a>(8).
<dl compact="">
<dt><b>--set </b>имя-множества флаг[,флаг...]

</dt><dd>
где флаги -
<b>src</b>

и/или
<b>dst</b>.

Множеств может быть не больше шести. Например, условию
<pre> iptables -A FORWARD -m set --set test src,dst
</pre>

будут соответствовать пакеты, адрес или порт (в зависимости от множества)
источника которых имеется во множестве.
<p>
Если адрес/порт имеется в множестве, и для соответствующего элемента множества
(либо для всего множества)
определён адрес назначения (т.е. адрес),
то для получения положительного результата необходимо также
чтобы совпадали адреса назначения.
</p></dd></dl>
<a name="lbCA">&nbsp;</a>
<h3>state</h3>

Используется с компонентом мониторинга соединений, 
и позволяет использовать состояние трассировки пакета.
<dl compact="">
<dt><b>--state </b><i>состояния</i>

</dt><dd>
Список фильтруемых состояний через запятую.
Возможные значения:
<b>INVALID</b>

- соединение, с которым связан пакет, определить не удалось,
например, из-за нехватки памяти, или пакет является сообщением об ошибке ICMP.
<b>ESTABLISHED</b>

- пакет принадлежит уже установленному соединению, через которое пакеты идут в
обоих направлениях.
<b>NEW</b>

- пакет открывает новое соединение или принадлежит однонаправленному (до
данного момента времени) потоку.
<b>RELATED</b>

- пакет принадлежит уже существующему соединению, но при этом он открывает
новое соединение.
Примером тому может служить передача данных по FTP или выдача сообщения ICMP об
ошибке создания соединения, которое должно было быть связано с существующим TCP
или UDP соединением.
</dd></dl>
<a name="lbCB">&nbsp;</a>
<h3>string</h3>

Фильтровать по содержимому пакета. Для работы требуется 
ядро linux &gt;= 2.6.14.
<dl compact="">
<dt><b>--algo  </b><i>bm|kmp</i>

</dt><dd>
Стратегия сравнения/поиска. (bm = Boyer-Moore, kmp = Knuth-Pratt-Morris)
</dd><dt><b>--from </b><i>позиция</i>

</dt><dd>
Позиция в данных с которой следует начинать поиск.
Значение по умолчанию - 0.
</dd><dt><b>--to </b><i>позиция</i>

</dt><dd>
Позиция в данных, при достижении которой следует прекращать поиск.
Значение по умолчанию - размер пакета.
</dd><dt><b>--string </b><i>последовательность</i>

</dt><dd>
Последовательность символов, которую следует искать в пакете.
<b>--hex-string </b><i>pattern</i>

Последовательность символов, которую следует искать в пакете (в
шестнадцатеричном представлении).
</dd></dl>
<a name="lbCC">&nbsp;</a>
<h3>tcp</h3>

Это расширение загружается при указании `--protocol tcp'.
Становятся доступными следующие ключи:
<dl compact="">
<dt><b>--source-port </b>[!] <i>порт</i>[:<i>порт</i>]

</dt><dd>
Исходный порт (или диапазон портов), с которого должен быть отправлен пакет для
прохождения теста.
В качестве значения может указываться номер порта или название сетевой службы. 
Диапазон (включительно) портов указывается в формате
<i>первый-порт</i>:<i>последний-порт</i>.

Если опускается первый порт, т.е. когда критерий записывается как --source-port
:80,
то в качестве начала диапазона принимается число 0.
Если опускается максимальный порт, т.е. когда критерий записывается как
--source-port 22:,
то в качестве конца диапазона принимается число 65535.
Если первый порт больше последнего, они меняются местами.
Краткая форма ключа -
<b>--sport .</b>

</dd><dt><b>--destination-port </b>[!] <i>порт</i>[:<i>порт</i>]

</dt><dd>
Порт (или диапазон портов) назначения. Краткая форма ключа -
<b>--dport .</b>

</dd><dt><b>--tcp-flags </b>[!] <i>флаги</i> <i>comp</i>

</dt><dd>
Пропускать пакеты с указанным набором флагов TCP.
Первый аргумент - флаги (через запятую), которые нужно проверять,
второй - те флаги, которые должны быть установлены.
Возможные флаги:
<b>SYN ACK FIN RST URG PSH ALL NONE</b>.

Так, условию
<pre> iptables -A FORWARD -p tcp --tcp-flags SYN,ACK,FIN,RST SYN
</pre>

будут соответствовать пакеты с установленным флагом SYN, и снятыми флагами
ACK, FIN, RST.
</dd><dt><b>[!] --syn</b>

</dt><dd>
Пропускать пакеты TCP с установленным флагом SYN и снятыми ACK,RST,FIN.
Такие пакеты используются для запроса создания TCP-соединения;
очевидно, блокирование таких пакетов приведёт к невозможности 
создания входящих TCP-соединений.
Эквивалентно <b>--tcp-flags SYN,RST,ACK,FIN SYN</b>.
При указании "!" перед "--syn", смысл ключа инвертируется.
</dd><dt><b>--tcp-option </b>[!] <i>номер-опции</i>

</dt><dd>
Пропускать пакеты с установленной опцией TCP.
</dd><dt><b>--mss </b><i>число</i>[:<i>число</i>]

</dt><dd>
Пропускать пакеты TCP SYN и SYN/ACK с указанным значением MSS (или значением
входящим в диапазон),
что ограничивает размер пакетов для соединения.
</dd></dl>
<a name="lbCD">&nbsp;</a>
<h3>tcpmss</h3>

Фильтрует по полю MSS (maximum segment size - максимальный размер сегмента)
заголовка TCP.
Возможно применять только к пакетам TCP SYN и SYN/ACK, 
т.к. MSS определяется в рамках процедуры согласования (handshake) в начале
соединения.
<dl compact="">
<dt><b>[!] --mss</b><i> число[:число]</i>

</dt><dd>
Пропускать пакеты с TCP MSS в указанном диапазоне.
</dd></dl>
<a name="lbCE">&nbsp;</a>
<h3>time</h3>

Фильтрует пакеты по времени/дате прибытия. Все ключи являются необязательными.
<dl compact="">
<dt><b> --timestart </b><i>чч:мм</i>

</dt><dd>
Пропускать только при времени прибытия после указанного (включительно). Значение
по умолчанию - 00:00.
</dd><dt><b>--timestop  </b><i>чч:мм</i>

</dt><dd>
Пропускать только при времени прибытия до указанного (включительно). Значение по
умолчанию - 23:59.
</dd><dt><b>--days </b><i>дни-недели</i>

</dt><dd>
Пропускать пакеты в указанные дни недели (Mon,Tue,Wed,Thu,Fri,Sat,Sun); по
умолчанию - в любой день)
</dd><dt><b>--datestart </b><i>ГГГГ[:ММ[:ДД[:чч[:мм[:сс]]]]]</i>

</dt><dd>
Пропускать только при дате прибытия после указанной (включительно).
Значение по умолчанию - 1970.
</dd><dt><b>--datestop </b><i>date</i>

</dt><dd>
Пропускать только при дате прибытия до указанной (включительно).
Значение по умолчанию - 2037.
</dd></dl>
<a name="lbCF">&nbsp;</a>
<h3>tos</h3>

Фильтрует по разрядам байта TOS (Type Of Service - говоря вообще, приоритет
пакета) в заголовке IP-пакета.
<dl compact="">
<dt><b>--tos </b><i>tos</i>

</dt><dd>
Стандартное имя (список можно вывести командой 
<br>

<br>&nbsp;iptables&nbsp;-m&nbsp;tos&nbsp;-h
<br>

) или число.
</dd></dl>
<a name="lbCG">&nbsp;</a>
<h3>ttl</h3>

Фильтрует по полю заголовка IP, определяющему время жизни пакета.
<dl compact="">
<dt><b>--ttl-eq </b><i>ttl</i>

</dt><dd>
Значение TTL должно быть равно указанному.
</dd><dt><b>--ttl-gt </b><i>ttl</i>

</dt><dd>
Значение TTL должно быть больше указанного.
</dd><dt><b>--ttl-lt </b><i>ttl</i>

</dt><dd>
Значение TTL должно быть меньше указанного.
</dd></dl>
<a name="lbCH">&nbsp;</a>
<h3>u32</h3>

Позволяет извлекать из пакета данные размером до 4 байт,
применять к ним операции логического И, сдвига, и проверять принадлежность
получающихся данных определённым диапазонам.
<p>
Более подробное описание и примеры доступны в исходном коде ядра.
<a name="lbCI">&nbsp;</a>
</p><h3>udp</h3>

Это расширение загружается при указании `--protocol udp'.
Доступны следующие ключи:
<dl compact="">
<dt><b>--source-port </b>[!] <i>порт</i>[:<i>порт</i>]

</dt><dd>
Диапазон, в который должен входить исходный порт.
См. описание ключа 
<b>--source-port</b>

расширения TCP.
</dd><dt><b>--destination-port </b>[!] <i>port</i>[:<i>port</i>]

</dt><dd>
Диапазон, в который должен входить целевой порт.
См. описание ключа 
<b>--destination-port</b>

расширения TCP.
</dd></dl>
<a name="lbCJ">&nbsp;</a>
<h3>unclean</h3>

Фильтрует предположительно ошибочные и бесполезные пакеты.
Это экспериментальный модуль.
<a name="lbCK">&nbsp;</a>
<h2>РАСШИРЕНИЯ МЕХАНИЗМА ОБРАБОТКИ</h2>

В iptables можно добавлять дополнительные цели: 
Далее описаны модули включенные в стандартную поставку.

<a name="lbCL">&nbsp;</a>
<h3>BALANCE</h3>

Позволяет равномерно распределять соединения между компьютерами в локальной
сети 
в заданном диапазоне (целевых) адресов.
<dl compact="">
<dt><b>--to-destination </b><i>ip1-ip2</i>

</dt><dd>
Диапазон адресов.
</dd></dl>
<a name="lbCM">&nbsp;</a>
<h3>CLASSIFY</h3>

Устанавливает значение skb-&gt;priority (т.е. классифицировать пакет по критерию
CBQ).
<dl compact="">
<dt><b>--set-class </b><i>главное-число:дополнительное-число</i>

</dt><dd>
Идентификатор класса
</dd></dl>
<a name="lbCN">&nbsp;</a>
<h3>CLUSTERIP</h3>

Позволяет реализовывать простые конфигурации кластеров с общим
IP и MAC без явного использования балансировщика (см. выше).
Соединения распределяются статически.
<dl compact="">
<dt><b>--new </b>

</dt><dd>
Добавить новый кластерный IP.
Этот ключ всегда необходимо использовать в первом правиле 
для данного кластерного IP.
</dd><dt><b>--hashmode </b><i>режим</i>

</dt><dd>
Режим хэширования:
<b>sourceip, sourceip-sourceport, sourceip-sourceport-destport</b>

</dd><dt><b>--clustermac </b><i>mac</i>

</dt><dd>
MAC кластерного IP. Это должен быть адрес для доставки подмножеству абонентов на
уровне канала связи.
</dd><dt><b>--total-nodes </b><i>число</i>

</dt><dd>
Общее число узлов в кластере.
</dd><dt><b>--local-node </b><i>число</i>

</dt><dd>
Число локальных узлов в кластере.
</dd><dt><b>--hash-init </b><i>случайное-число</i>

</dt><dd>
Начальное число для инициализации хэша.
</dd></dl>
<a name="lbCO">&nbsp;</a>
<h3>CONNMARK</h3>

Помечает соединения.
<dl compact="">
<dt><b>--set-mark метка[/маска]</b>

</dt><dd>
Метка соединения. Если указана маска, изменяются только разряды которые равны
единице в маске.
</dd><dt><b>--save-mark [--mask маска]</b>

</dt><dd>
Перенести метку пакета в соединение. Если указана маска, копируются только
разряды, которые равны единице в маске.
</dd><dt><b>--restore-mark [--mask маска]</b>

</dt><dd>
Перенести метку соединения в пакет. 
Если указана маска, копируются только разряды, которые равны единице в маске.
Допустимо только в таблице 
<b>mangle .</b>

</dd></dl>
<a name="lbCP">&nbsp;</a>
<h3>CONNSECMARK</h3>

Переносит метки механизма защиты из пакетов в соединения 
(если они ещё не имеют меток), и из соединений обратно в пакеты
(также если они ещё не имеют меток).
Обычно используется совместно с SECMARK и только в таблице 
<b>mangle .</b>

<dl compact="">
<dt><b>--save</b>

</dt><dd>
Если пакет имеет метку, а соединение нет, то перенести её в соединение.
</dd><dt><b>--restore</b>

</dt><dd>
Если соединение имеет метку, а пакет нет, то перенести её в соединение.
</dd></dl>
<a name="lbCQ">&nbsp;</a>
<h3>DNAT</h3>

Применяется только в таблице 
<b>nat</b>

и цепочках 
<b>PREROUTING ,</b>

<b>OUTPUT</b>

и вызываемых из них цепочках определяемых пользователем.
DNAT (Destination Network Address Translation) используется для преобразования
адреса места назначения в IP заголовке пакета.
Если пакет подпадает под критерий правила, выполняющего DNAT, то этот пакет, и
все последующие пакеты из этого же потока, будут подвергнуты преобразованию
адреса назначения и переданы на требуемое устройство, хост или сеть.
Доступен один ключ:
<dl compact="">
<dt><b>--to-destination </b>

</dt><dd>
"[<i>ip-адрес</i>][-<i>ip-адрес</i>][:<i>порт</i>-<i>порт</i>]"
Определяет новый целевой IP-адрес, либо диапазон (включительно)
IP-адресов и (необязательно) диапазон портов (последнее
допустимо только при указании 
<b>-p tcp</b>

или 
<b>-p udp</b>).

Если диапазон портов не указывается, порты не будут меняться.
То же самое относится IP-адресов.
<dl compact=""><dt></dt><dd>
<p>

При использовании ядра до 2.6.10 допустимо указание нескольких ключей
--to-destination.
В этом случае производится простая кольцевая балансировка.
Ядра (&gt;= 2.6.11-rc1) не позволяют распределять нагрузку по нескольким диапазонам
IP-адресов.
</p><p>
</p></dd></dl>
</dd></dl>
<a name="lbCR">&nbsp;</a>
<h3>DSCP</h3>

Позволяет изменять разряды DSCP в заголовке TOS пакетов IPv4.
Может использоваться только в mangle.
<dl compact="">
<dt><b>--set-dscp </b><i>значение</i>

</dt><dd>
Устанавливать поле DSCP в указанное значение (десятичное или шестнадцатеричное)
</dd><dt><b>--set-dscp-class </b><i>класс</i>

</dt><dd>
Устанавливать класс DiffServ в поле DSCP.
</dd></dl>
<a name="lbCS">&nbsp;</a>
<h3>ECN</h3>

Позволяет закрывать известные "дыры" ECN.
Используется в mangle.
<dl compact="">
<dt><b>--ecn-tcp-remove</b>

</dt><dd>
Удалять все разряды ECN из заголовка TCP.
Используется вместе с 
<b>-p tcp</b>.

</dd></dl>
<a name="lbCT">&nbsp;</a>
<h3>IPMARK</h3>

Отмечает принимаемые пакеты на основе IP-адресов, связанных с ними.
Позволяет заменить несколько записей mangle/mark одной
в случае использования классификатора брандмауэра.
<p>
Используется в mangle, PREROUTING,
POSTROUTING и FORWARD.
</p><dl compact="">
<dt><b>--addr </b><i>src/dst</i>

</dt><dd>
IP-адрес, с которым следует работать: исходный или конечный.
</dd><dt><b>--and-mask </b><i>маска</i>

</dt><dd>
Применять логическое И маски к IP-адресу.
</dd><dt><b>--or-mask </b><i>mask</i>

</dt><dd>
Применять логическое ИЛИ маски к IP-адресу.

Порядок байт IP-адрес обращается для соответствия представлениям человека:
192.168.0.1 - 0xc0a80001. Сначала выполняется операция И, затем ИЛИ.
<p>
Примеры:
</p><p>
Создадим очередь для каждого пользователя, номер очереди будет соответствовать 
IP-адресу: все пакеты приходящие от/отправляемые в 192.168.5.2
будут перенаправляться в очередь 1:0502, 192.168.5.12 -&gt; 1:050c и т.д.
</p><p>
Имеется одно правило классификации:
</p></dd><dt></dt><dd>
tc filter add dev eth3 parent 1:0 protocol ip fw

Теперь вместо:
</dd><dt></dt><dd>
iptables -t mangle -A POSTROUTING -o eth3 -d 192.168.5.2 -j MARK
--set-mark 0x10502
</dd><dt></dt><dd>
iptables -t mangle -A POSTROUTING -o eth3 -d 192.168.5.3 -j MARK
--set-mark 0x10503

можно будет указать:
</dd><dt></dt><dd>
iptables -t mangle -A POSTROUTING -o eth3 -j IPMARK --addr=dst
--and-mask=0xffff --or-mask=0x10000

Это значительно (вдвое) уменьшает нагрузку на маршрутизаторы, обслуживающие
сотни пользователей.
</dd></dl>
<a name="lbCU">&nbsp;</a>
<h3>IPV4OPTSSTRIP</h3>

Удаляет все опции IP из пакета.
<p>
Никаких дополнительных параметров не требуется:
</p><p>
# iptables -t mangle -A PREROUTING -j IPV4OPTSSTRIP
<a name="lbCV">&nbsp;</a>
</p><h3>LOG</h3>

Вносить в протокол ядра записи о пакетах (например, поля заголовка IP), для
которых указана данная цель.
Протокол ядра доступен по команде 
<i>dmesg .</i>

См.
<i><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=syslogd&amp;category=8">syslogd</a></i>(8)).

Обработка после этой цели продолжается.
Так, для внесения записей о блокируемых пакетах 
укажите два отдельных правила с одинаковыми условиями,
для первого укажите цель LOG, для второго - DROP (или REJECT).
<dl compact="">
<dt><b>--log-level </b><i>уровень</i>

</dt><dd>
Степень подробности (число, см. <i><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=syslog.conf&amp;category=5">syslog.conf</a></i>(5)).
</dd><dt><b>--log-prefix </b><i>префикс</i>

</dt><dd>
Префикс для выделения записей протокола среди других. До 29 символов.
</dd><dt><b>--log-tcp-sequence</b>

</dt><dd>
Протоколировать номера последовательностей (sequence numbers) TCP.
Если протокол доступен обычным пользователям, это отрицательно скажется на
защищённости системы.
</dd><dt><b>--log-tcp-options</b>

</dt><dd>
Вносить в протокол параметры заголовка TCP.
</dd><dt><b>--log-ip-options</b>

</dt><dd>
Вносить в протокол параметры заголовка IP.
</dd><dt><b>--log-uid</b>

</dt><dd>
Вносить в протокол идентификатор пользователя, которому принадлежит процесс,
сгенерировавший пакет.
</dd></dl>
<a name="lbCW">&nbsp;</a>
<h3>MARK</h3>

Используется для присвоения пакетам меток.
Может использоваться только в пределах таблицы
<b>mangle .</b>

Обычно используется вместе с iproute2.
<dl compact="">
<dt><b>--set-mark </b><i>значение</i>

</dt><dd>
Задать значение nfmark.
</dd><dt><b>--and-mark </b><i>значение</i>

</dt><dd>
Выполнить операцию "логическое И" над значением nfmark и указанным.
</dd><dt><b>--or-mark </b><i>значение</i>

</dt><dd>
Выполнить операцию "логическое ИЛИ" над значением nfmark и указанным.
</dd></dl>
<a name="lbCX">&nbsp;</a>
<h3>MASQUERADE</h3>

Цель допустима только в таблице 
<b>nat</b>

в цепочке 
<b>POSTROUTING ,</b>

для конфигураций с динамической выдачей IP (dialup):
если у вас статический IP-адрес, используйте SNAT (это уменьшит нагрузку на
систему).
Маскарадинг - это по сути привязывание к IP-адресу интерфейса, через который
пакет выходит, но он также имеет хорошее свойство - 
<i>забывать</i>

соединения при остановке сетевого интерфейса.
Это корректное поведение если каждый раз при установлении связи с Internet
получается новый адрес (потому имеющиеся соединения теряются в любом случае).
<dl compact="">
<dt><b>--to-ports </b><i>порт</i>[-<i>порт</i>]

</dt><dd>
Диапазон исходных портов, который следует использовать вместо 
эвристически определяемого модулем
<b>SNAT</b>

(см. выше).  Допустимо только при указании 
<b>-p tcp</b>

или 
<b>-p udp</b>.

</dd></dl>
<a name="lbCY">&nbsp;</a>
<h3>MIRROR</h3>

Экспериментальная цель, созданная в демонстрационных целях,
поскольку это действие может привести к "зацикливанию" пакета и, в результате, к
отказу в обслуживании.
<p>
Данное действие допускается использовать только в цепочках
<b>INPUT</b>,

<b>FORWARD ,</b>

<b>PREROUTING</b>

и в цепочках, вызываемых из них.
Пакеты, отправляемые в сеть действием MIRROR, больше не подвергаются фильтрации,
трассировке или NAT, избегая тем самым "зацикливания" и других неприятностей.
<b>NOT .</b>

<a name="lbCZ">&nbsp;</a>
</p><h3>NETMAP</h3>

Позволяет задать статическое отображение адресов одной подсети в адреса другой.
Используется только в таблице
<b>nat .</b>

<dl compact="">
<dt><b>--to </b><i>адрес[/маска]</i>

</dt><dd>
Целевой адрес (или диапазон адресов).
Отображённый адрес будет получаться следующим образом:
все единицы в маске заменяются на цифры в соответствующих позициях
нового "адреса";
все остальные разряды заполняются из отображаемого адреса.
</dd></dl>
<a name="lbDA">&nbsp;</a>
<h3>NFQUEUE</h3>

Это расширение QUEUE. 
В отличие от QUEUE, позволяет помещать пакет в определённую очередь,
идентифицируемую по 16-разрядному номеру.
<dl compact="">
<dt><b>--queue-num </b><i>номер</i>

</dt><dd>
Номер очереди QUEUE. Допустимые номера - от 0 до 65535.
По умолчанию - 0.
</dd><dt>Работает только с ядрами 2.6.14 и позже, т.к. требует поддержку</dt><dd>
<b>nfnetlink_queue.</b>

</dd></dl>
<a name="lbDB">&nbsp;</a>
<h3>NOTRACK</h3>

Исключает пакет из множества наблюдаемых.
<dl compact="">
<dt>Используется только в таблице</dt><dd>
<b>raw .</b>

</dd></dl>
<a name="lbDC">&nbsp;</a>
<h3>REDIRECT</h3>

Может использоваться только в цепочках 
<b>PREROUTING</b>

и 
<b>OUTPUT</b>

таблицы
<b>nat ,</b>

а также в цепочках, вызываемых из вышеуказанных.
<p>
Выполняет перенаправление пакетов на другой порт той же самой машины.
Очень удобно для выполнения "прозрачного" проксирования (transparent proxying),
когда машины в локальной сети даже не подозревают о существовании
прокси-сервера.
При перенаправлении целевой IP-адрес пакета меняется на 
основной адрес интерфейса отправки 
(локальным пакетам присваивается 127.0.0.1).
Для действия REDIRECT предусмотрен только один ключ:
</p><dl compact="">
<dt><b>--to-ports </b><i>порт</i>[-порт]

</dt><dd>
Диапазон портов, на которые следует перенаправлять пакет.
Допустимо только при указании 
<b>-p tcp</b>

или 
<b>-p udp</b>.

</dd></dl>
<a name="lbDD">&nbsp;</a>
<h3>REJECT</h3>

Используется для отправки сообщения об ошибке на хост, от которого получен
исходный пакет, в остальном эквивалентно 
<b>DROP ,</b>

обработка пакета останавливается на этой цели.
Может использоваться только в цепочках 
<b>INPUT</b>,

<b>FORWARD ,</b>

<b>OUTPUT ,</b>

а также в цепочках, вложенных в них.
Следующий ключ определяет форму пакета с сообщением об ошибке:
<dl compact="">
<dt><b>--reject-with </b><i>тип</i>

</dt><dd>
Сообщение ICMP об ошибке.
Возможные значения:
<pre><b> icmp-net-unreachable</b>
<b> icmp-host-unreachable</b>
<b> icmp-port-unreachable</b>
<b> icmp-proto-unreachable</b>
<b> icmp-net-prohibited</b>
<b> icmp-host-prohibited</b>
<b> icmp-admin-prohibited (*)</b>
</pre>

По умолчанию отправляется <b>port-unreachable</b>. 
Для правил, которые фильтруют пакеты только принадлежащие протоколу TCP,
можно указывать
<b>tcp-reset :</b>

это приведёт к возврату пакетов TCP RST и полезно для блокирования тестов
<i>ident</i>

(113/tcp) выполняемых при отправке почты на недоступные узлы.
</dd><dt>(*) Указание icmp-admin-prohibited в случае если ядро не поддерживает этого</dt><dd>
равносильно цели DROP
</dd></dl>
<a name="lbDE">&nbsp;</a>
<h3>ROUTE</h3>

Позволяет явно изменять логику маршрутизации сетевой подсистемы. Используется в
таблице
<b>mangle .</b>

<dl compact="">
<dt><b>--oif </b><i>интерфейс</i>

</dt><dd>
Направить пакет через указанный интерфейс.
</dd><dt><b>--iif </b><i>интерфейс</i>

</dt><dd>
Изменить сведения об интерфейсе, который доставил пакет.
</dd><dt><b>--gw </b><i>IP-адрес</i>

</dt><dd>
Направить пакет через указанный шлюз.
</dd><dt><b>--continue </b>

</dt><dd>
Не прекращать тестирование пакета в цепочке.
Недопустимо, если указан один из ключей `--iif' / `--tee'
</dd><dt><b>--tee </b>

</dt><dd>
Выполнять указанные действия над копией пакета,
не прекращать тестирование исходного пакета в цепочке.
Недопустимо, если указан один из ключей `--iif' / `--continue'
</dd></dl>
<a name="lbDF">&nbsp;</a>
<h3>SAME</h3>

Аналогично SNAT/DNAT, в зависимости от цепочки: на вход принимается
диапазон адресов
(`--to 1.2.3.4-1.2.3.7'), после чего клиентам выдаётся 
одна и та же пара исходного/целевого адресов для одного соединения.
<dl compact="">
<dt><b>--to </b><i>ip1-ip2</i>

</dt><dd>
Адреса, в которые будут отображаться получаемые адреса пакетов.
Допустимо указание нескольких ключей.
</dd><dt><b>--nodst</b>

</dt><dd>
Не учитывать изначальный целевой IP-адрес при определении нового исходного
адреса.
</dd></dl>
<a name="lbDG">&nbsp;</a>
<h3>SECMARK</h3>

Устанавливает метки механизма защиты в пакетах.
Они используются подсистемами защиты наподобие SELinux.
Допустимо указание только в таблице
<b>mangle .</b>

<dl compact="">
<dt><b>--selctx </b><i>контекст-защиты</i>

</dt><dd>
</dd></dl>
<a name="lbDH">&nbsp;</a>
<h3>SET</h3>

Добавляет и удаляет элементы из множеств IP, определяемых с помощью <a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=ipset&amp;category=8">ipset</a>(8).
<dl compact="">
<dt><b>--add-set </b>имя-множества флаг[,флаг...]

</dt><dd>
Добавить адреса/порты пакета в указанные множества
</dd><dt><b>--del-set </b>имя-множества флаг[,флаг...]

</dt><dd>
Удалить адреса/порты пакета в указанные множества, где
флаги - 
<b>src</b>

и/или 
<b>dst</b>,

ограничение - 6 штук.
</dd><dt>Для многоуровневого добавления/удаления элементов с помощью SET</dt><dd>
необходимо предварительно определить связывание (адресов).
</dd></dl>
<a name="lbDI">&nbsp;</a>
<h3>SNAT</h3>

Используется только в цепочке
<b>POSTROUTING</b>

таблицы
<b>nat .</b>

Изменяет адрес источника пакета, если он удовлетворяет условиям,
и всех последующих пакетов соединения (последние не будут тестироваться).
<dl compact="">
<dt><b>--to-source  </b><i>ip1</i>[-<i>ip2</i>][:<i>порт1</i>-<i>порт2</i>]

</dt><dd>
IP-адрес или диапазон адресов (включительно) источника, а также (необязательно,
и только в случае
<b>-p tcp</b>

или 
<b>-p udp</b>)

диапазон портов.
Если последний не указан, то выполняются следующие отображения:
порты до 512 будут отображаться в порты до 512;
порты от 512 до 1023 включительно - в порты до 1024;
остальные - в порты начиная с 1024.
По возможности порты будут отображаться сами в себя.
<dl compact=""><dt></dt><dd>
<p>

В ядрах до 2.6.10 возможно указание нескольких ключей --to-source.
В этом случае производится простая кольцевая балансировка.
Ядра &gt;= 2.6.11-rc1 не могут работать с несколькими диапазонами IP-адресов.
</p></dd></dl>
</dd></dl>
<a name="lbDJ">&nbsp;</a>
<h3>TARPIT</h3>

Удерживает входящие соединения TCP (объём используемых модулем ресурсов не
зависит от количества соединений).
Запросы на установление соединения принимаются, но сразу после этого
соединения переводятся в состояние удерживания (persist - окно нулевого
размера),
в которых удалённая сторона не посылает никаких данных, и только
отправляет запросы на продолжение каждые 60-240 секунд.
Попытки закрытия соединения игнорируются, и оно закрывается по истечении времени
ожидания
(12-24 минут).
<p>
Аналогично LaBrea
&lt;<a href="http://www.hackbusters.net/LaBrea/">http://www.hackbusters.net/LaBrea/</a>&gt;, но не требует выделенного сервера 
и IP-адресов. Любой порт TCP, для которого иначе бы выполнялось одно из действий
DROP или REJECT,
может удерживать соединения (стать tarpit).
</p><p>
Для удерживания соединений на порт TCP 80 данного компьютера:
</p><dl compact="">
<dt></dt><dd>
iptables -A INPUT -p tcp -m tcp --dport 80 -j TARPIT

Для значительного замедления сканирования неиспользуемых адресов по схеме 
Code Red/Nimda перенаправьте их на компьютер с Linux, не выполняющий функцию
маршрутизации
(ip route 10.0.0.0 255.0.0.0 ip.of.linux.box на Cisco), включите перенаправление
IP
на компьютере с Linux и:
</dd><dt></dt><dd>
iptables -A FORWARD -p tcp -j TARPIT
</dd><dt></dt><dd>
iptables -A FORWARD -j DROP
</dd><dt>Примечание:</dt><dd>
Если вы используете модуль conntrack, то необходимо также указывать цель
NOTRACK, иначе ядро будет выделять ресурсы без надобности для каждого
удерживаемого соединения.
Так, при удерживании входящих соединений на порт IRC:
</dd><dt></dt><dd>
iptables -t raw -A PREROUTING -p tcp --dport 6667 -j NOTRACK
</dd><dt></dt><dd>
iptables -A INPUT -p tcp --dport 6667 -j TARPIT
</dd></dl>
<a name="lbDK">&nbsp;</a>
<h3>TCPMSS</h3>

Позволяет изменять значение MSS пакетов TCP SYN, для ограничения 
размера пакетов соединения (обычно ограничение равно 
MTU исходящего интерфейса минус 40).
Натурально, может использоваться только при 
<b>-p tcp</b>,

в таблице 
<b>mangle</b>.

<br>

Эта цель полезна если провайдер или серверы блокируют 
пакеты ICMP запроса фрагментации.
Определить, так ли это в вашем случае, легко:
с компьютера Linux, выступающего в роли брандмауэра/маршрутизатора
всё работает, но компьютеры, которые он обслуживает, не могут обмениваться
пакетами большого размера:

<dl compact=""><dt></dt><dd>
<dl compact="">
<dt>1)</dt><dd>
Веб-браузеры устанавливают соединение, но не получают никаких данных.
</dd><dt>2)</dt><dd>
Не удаётся получать электронные сообщения большого размера.
</dd><dt>3)</dt><dd>
ssh работает нормально, но scp бездействует после процедуры согласования.
</dd></dl>
</dd></dl>


Как это можно исправить: включите указанную опцию и добавьте правило
в брандмауэр:
<pre> iptables -t mangle -A FORWARD -p tcp --tcp-flags SYN,RST SYN \
             -j TCPMSS --clamp-mss-to-pmtu
</pre>

<dl compact="">
<dt><b>--set-mss </b><i>значение</i>

</dt><dd>
Значение опции MSS, которое следует устанавливать.
</dd><dt><b>--clamp-mss-to-pmtu</b>

</dt><dd>
Автоматически вычислять значение MSS по формуле (path_MTU - 40).
</dd><dt>Допустимо одновременное указание только одного из этих ключей.</dt><dd>
</dd></dl>
<a name="lbDL">&nbsp;</a>
<h3>TOS</h3>

Используется для установки разрядов в поле Type of Service заголовка IP.
Допустимо только в таблице 
<b>mangle .</b>

<dl compact="">
<dt><b>--set-tos </b><i>tos</i>

</dt><dd>
Возможно указание значения в виде числа или имени в соответствии со списком 
<pre> iptables -j TOS -h
</pre>

</dd></dl>
<a name="lbDM">&nbsp;</a>
<h3>TRACE</h3>

Включает 
<b>трассировку пакетов </b>

соответствующих условию правила.
<a name="lbDN">&nbsp;</a>
<h3>TTL</h3>

Используется для изменения содержимого поля Time To Live в заголовке IPv4.
TTL определяет число маршрутизаторов которое пакет должен пройти прежде чем он
будет считаться утерянным.
<dl compact="">
<dt>Изменение (особенно - увеличение) поля TTL может быть опасным, потому желательно</dt><dd>
избегать этого.
</dd><dt><b>Никогда не изменяйте (особенно - не увеличивайте) TTL пакетов, покидающих</b>

</dt><dd>
локальную сеть.
Таблица
<b>mangle .</b>

</dd><dt><b>--ttl-set </b><i>число</i>

</dt><dd>
Установить новое значение TTL.
</dd><dt><b>--ttl-dec </b><i>число</i>

</dt><dd>
Уменьшить значение TTL на указанное число.
</dd><dt><b>--ttl-inc </b><i>число</i>

</dt><dd>
Увеличить значение TTL на указанное число.
</dd></dl>
<a name="lbDO">&nbsp;</a>
<h3>ULOG</h3>

Предоставляет возможность протоколирования сведений о пакетах в пользовательском
пространстве.
При использовании этого действия пакет через сокеты 
<i>netlink</i>

доставляется произвольному количеству адресатов.
В качестве адресатов выступают процессы в пользовательском пространстве.
Как и в случае с LOG, тестирование пакета в цепочке не прекращается.
<dl compact="">
<dt><b>--ulog-nlgroup </b><i>группа-netlink</i>

</dt><dd>
Группа netlink (1-32), которой следует посылать пакет.
Значение по умолчанию - 1.
</dd><dt><b>--ulog-prefix </b><i>префикс</i>

</dt><dd>
Префикс для записей в протоколе для выделения среди других сообщений.
До 32 символов.
</dd><dt><b>--ulog-cprange </b><i>размер</i>

</dt><dd>
Количество байтов, которое следует переносить в пользовательское пространство.
По умолчанию - 0 (копировать весь пакет).
</dd><dt><b>--ulog-qthreshold </b><i>размер</i>

</dt><dd>
Размер буфера пакетов в ядре. При заполнении буфера он будет посылаться в
пользовательское пространство 
как одно сообщение netlink. По умолчанию - 1 (для обратной совместимости).
<br>

</dd></dl>
<a name="lbDP">&nbsp;</a>
<h3>XOR</h3>

Шифровать трафик TCP и UDP простым кодом XOR
<dl compact="">
<dt><b>--key </b><i>строка</i>

</dt><dd>
Ключ.
</dd><dt><b>--block-size</b>

</dt><dd>
Размер блока
</dd></dl>
<a name="lbDQ">&nbsp;</a>
<h2>ДИАГНОСТИКА</h2>

Разнообразные сообщения выводятся на стандартный вывод.
Код выхода в случае отсутствия ошибок - 0.
Если команде переданы недопустимые ключи, код выхода равен 2,
при остальных ошибках код выхода равен 1.
<a name="lbDR">&nbsp;</a>
<h2>ОШИБКИ</h2>

См. <a href="http://bugzilla.netfilter.org/">http://bugzilla.netfilter.org/</a>
<a name="lbDS">&nbsp;</a>
<h2>СОВМЕСТИМОСТЬ С IPCHAINS</h2>

Пакет
<b>iptables</b>

очень похож на ipchains, написанные Расти Расселом (Rusty Russell).
Основное различие состоит в том, что цепочки
<b>INPUT</b>

и
<b>OUTPUT</b>

не применяются для "проходящих" пакетов.
Потому каждый пакет проходит только через одну из цепочек
(кроме трафика кольцевого интерфейса loopback, проходящего через 
INPUT и OUTPUT).
<p>

Другое различие состоит в том, что
<b>-i</b>

относится с входному интерфейсу;
<b>-o</b>

- к выходному, и оба они доступны для пакетов 
в цепочке 
<b>FORWARD .</b>

</p><p>

В стандартной конфигурации 
<b>iptables </b>

работает как фильтр пакетов (таблица `filter'), и к нему можно подключать
дополнительные расширения.
Это должно помочь избежать "неразберихи" с 
IP-маскарадингом и собственно фильтрацией.
Так, следующие ключи обрабатываются иначе:
</p><pre> -j MASQ
 -M -S
 -M -L
</pre>

Натурально, имеется много менее значительных изменений.
<a name="lbDT">&nbsp;</a>
<h2>СМ. ТАКЖЕ</h2>

<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=iptables-save&amp;category=8">iptables-save</a></b>(8),

<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=iptables-restore&amp;category=8">iptables-restore</a></b>(8),

<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=ip6tables&amp;category=8">ip6tables</a></b>(8),

<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=ip6tables-save&amp;category=8">ip6tables-save</a></b>(8),

<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=ip6tables-restore&amp;category=8">ip6tables-restore</a></b>(8),

<b><a href="https://www.opennet.ru/cgi-bin/opennet/man.cgi?topic=libipq&amp;category=3">libipq</a></b>(3).


О фильтрации пакетов более подробно написано в packet-filtering-HOWTO,
о трансляции адресов - в NAT-HOWTO,
о нестандартных расширениях - в netfilter-extensions-HOWTO,
о программировании - в netfilter-hacking-HOWTO.
<br>

См. 
<b><a href="http://www.netfilter.org/">http://www.netfilter.org/</a></b>

и
<b><a href="http://www.linuxshare.ru/docs/security/iptables/iptables-tutorial.html.">http://www.linuxshare.ru/docs/security/iptables/iptables-tutorial.html.</a></b>

<a name="lbDU">&nbsp;</a>
<h2>АВТОРЫ</h2>

Пакет создал Расти Рассел (Rusty Russell), консультируясь с 
Майклом Ньюлингом (Michael Neuling) на ранних этапах.
<p>

Благодаря Марку Бушэ (Marc Boucher) был удалён код ipnatctl,
он был заменен более общей инфраструктурой отбора пакетов.
Им была реализована таблица mangle, фильтрация по владельцу,
метки и ещё много чего другого.
</p><p>

Джеймс Моррис (James Morris) реализовал цель TOS и фильтрацию по tos.
</p><p>

Джозеф Кадлецик (Jozsef Kadlecsik) реализовал цель REJECT.
</p><p>

Гаральд Уэльт (Harald Welte) реализовал цели ULOG и nd NFQUEUE,
libiptc, а также цели и фильтры TTL, DSCP, ECN.
</p><p>

Команду Netfilter Core Team составляют: Марк Бушэ (Marc Boucher),
Мартин Джозефсон (Martin Josefsson),
Дожзеф Кадлецик (Jozsef Kadlecsik), 
Патрик МакХарди (Patrick McHardy),
Джеймс Моррис (James Morris),
Гаральд Уэльт (Harald Welte)
и Расти Рассел (Rusty Russell).
</p><p>

Настоящий документ написан Херви Ейчинном (Herve Eychenne) &lt;<a href="mailto:rv@wallfire.org">rv@wallfire.org</a>&gt;.



</p><p>
<a name="lbDV">&nbsp;</a>
</p><h2>ПЕРЕВОД</h2>

Николай Шафоростов &lt;<a href="mailto:shafff@ukr.net">shafff@ukr.net</a>&gt; 2007
<p>
</p><p>

</p><hr>
<a name="index">&nbsp;</a><h2>Index</h2>
<dl>
<dt><a href="#lbAB">ИМЯ</a></dt><dd>
</dd><dt><a href="#lbAC">ОБЗОР</a></dt><dd>
</dd><dt><a href="#lbAD">ОПИСАНИЕ</a></dt><dd>
</dd><dt><a href="#lbAE">ЦЕЛИ</a></dt><dd>
</dd><dt><a href="#lbAF">ТАБЛИЦЫ</a></dt><dd>
</dd><dt><a href="#lbAG">ОПЦИИ</a></dt><dd>
<dl>
<dt><a href="#lbAH">КОМАНДЫ</a></dt><dd>
</dd><dt><a href="#lbAI">ПАРАМЕТРЫ</a></dt><dd>
</dd><dt><a href="#lbAJ">ПРОЧИЕ ОПЦИИ</a></dt><dd>
</dd></dl>
</dd><dt><a href="#lbAK">РАСШИРЕНИЯ МЕХАНИЗМА ТЕСТИРОВАНИЯ</a></dt><dd>
<dl>
<dt><a href="#lbAL">account</a></dt><dd>
</dd><dt><a href="#lbAM">addrtype</a></dt><dd>
</dd><dt><a href="#lbAN">ah</a></dt><dd>
</dd><dt><a href="#lbAO">childlevel</a></dt><dd>
</dd><dt><a href="#lbAP">comment</a></dt><dd>
</dd><dt><a href="#lbAQ">condition</a></dt><dd>
</dd><dt><a href="#lbAR">connbytes</a></dt><dd>
</dd><dt><a href="#lbAS">connlimit</a></dt><dd>
</dd><dt><a href="#lbAT">connmark</a></dt><dd>
</dd><dt><a href="#lbAU">connrate</a></dt><dd>
</dd><dt><a href="#lbAV">conntrack</a></dt><dd>
</dd><dt><a href="#lbAW">dccp</a></dt><dd>
</dd><dt><a href="#lbAX">dscp</a></dt><dd>
</dd><dt><a href="#lbAY">dstlimit</a></dt><dd>
</dd><dt><a href="#lbAZ">ecn</a></dt><dd>
</dd><dt><a href="#lbBA">esp</a></dt><dd>
</dd><dt><a href="#lbBB">fuzzy</a></dt><dd>
</dd><dt><a href="#lbBC">hashlimit</a></dt><dd>
</dd><dt><a href="#lbBD">helper</a></dt><dd>
</dd><dt><a href="#lbBE">icmp</a></dt><dd>
</dd><dt><a href="#lbBF">iprange</a></dt><dd>
</dd><dt><a href="#lbBG">ipv4options</a></dt><dd>
</dd><dt><a href="#lbBH">length</a></dt><dd>
</dd><dt><a href="#lbBI">limit</a></dt><dd>
</dd><dt><a href="#lbBJ">mac</a></dt><dd>
</dd><dt><a href="#lbBK">mark</a></dt><dd>
</dd><dt><a href="#lbBL">mport</a></dt><dd>
</dd><dt><a href="#lbBM">multiport</a></dt><dd>
</dd><dt><a href="#lbBN">nth</a></dt><dd>
</dd><dt><a href="#lbBO">osf</a></dt><dd>
</dd><dt><a href="#lbBP">owner</a></dt><dd>
</dd><dt><a href="#lbBQ">physdev</a></dt><dd>
</dd><dt><a href="#lbBR">pkttype</a></dt><dd>
</dd><dt><a href="#lbBS">policy</a></dt><dd>
</dd><dt><a href="#lbBT">psd</a></dt><dd>
</dd><dt><a href="#lbBU">quota</a></dt><dd>
</dd><dt><a href="#lbBV">random</a></dt><dd>
</dd><dt><a href="#lbBW">realm</a></dt><dd>
</dd><dt><a href="#lbBX">recent</a></dt><dd>
</dd><dt><a href="#lbBY">sctp</a></dt><dd>
</dd><dt><a href="#lbBZ">set</a></dt><dd>
</dd><dt><a href="#lbCA">state</a></dt><dd>
</dd><dt><a href="#lbCB">string</a></dt><dd>
</dd><dt><a href="#lbCC">tcp</a></dt><dd>
</dd><dt><a href="#lbCD">tcpmss</a></dt><dd>
</dd><dt><a href="#lbCE">time</a></dt><dd>
</dd><dt><a href="#lbCF">tos</a></dt><dd>
</dd><dt><a href="#lbCG">ttl</a></dt><dd>
</dd><dt><a href="#lbCH">u32</a></dt><dd>
</dd><dt><a href="#lbCI">udp</a></dt><dd>
</dd><dt><a href="#lbCJ">unclean</a></dt><dd>
</dd></dl>
</dd><dt><a href="#lbCK">РАСШИРЕНИЯ МЕХАНИЗМА ОБРАБОТКИ</a></dt><dd>
<dl>
<dt><a href="#lbCL">BALANCE</a></dt><dd>
</dd><dt><a href="#lbCM">CLASSIFY</a></dt><dd>
</dd><dt><a href="#lbCN">CLUSTERIP</a></dt><dd>
</dd><dt><a href="#lbCO">CONNMARK</a></dt><dd>
</dd><dt><a href="#lbCP">CONNSECMARK</a></dt><dd>
</dd><dt><a href="#lbCQ">DNAT</a></dt><dd>
</dd><dt><a href="#lbCR">DSCP</a></dt><dd>
</dd><dt><a href="#lbCS">ECN</a></dt><dd>
</dd><dt><a href="#lbCT">IPMARK</a></dt><dd>
</dd><dt><a href="#lbCU">IPV4OPTSSTRIP</a></dt><dd>
</dd><dt><a href="#lbCV">LOG</a></dt><dd>
</dd><dt><a href="#lbCW">MARK</a></dt><dd>
</dd><dt><a href="#lbCX">MASQUERADE</a></dt><dd>
</dd><dt><a href="#lbCY">MIRROR</a></dt><dd>
</dd><dt><a href="#lbCZ">NETMAP</a></dt><dd>
</dd><dt><a href="#lbDA">NFQUEUE</a></dt><dd>
</dd><dt><a href="#lbDB">NOTRACK</a></dt><dd>
</dd><dt><a href="#lbDC">REDIRECT</a></dt><dd>
</dd><dt><a href="#lbDD">REJECT</a></dt><dd>
</dd><dt><a href="#lbDE">ROUTE</a></dt><dd>
</dd><dt><a href="#lbDF">SAME</a></dt><dd>
</dd><dt><a href="#lbDG">SECMARK</a></dt><dd>
</dd><dt><a href="#lbDH">SET</a></dt><dd>
</dd><dt><a href="#lbDI">SNAT</a></dt><dd>
</dd><dt><a href="#lbDJ">TARPIT</a></dt><dd>
</dd><dt><a href="#lbDK">TCPMSS</a></dt><dd>
</dd><dt><a href="#lbDL">TOS</a></dt><dd>
</dd><dt><a href="#lbDM">TRACE</a></dt><dd>
</dd><dt><a href="#lbDN">TTL</a></dt><dd>
</dd><dt><a href="#lbDO">ULOG</a></dt><dd>
</dd><dt><a href="#lbDP">XOR</a></dt><dd>
</dd></dl>
</dd><dt><a href="#lbDQ">ДИАГНОСТИКА</a></dt><dd>
</dd><dt><a href="#lbDR">ОШИБКИ</a></dt><dd>
</dd><dt><a href="#lbDS">СОВМЕСТИМОСТЬ С IPCHAINS</a></dt><dd>
</dd><dt><a href="#lbDT">СМ. ТАКЖЕ</a></dt><dd>
</dd><dt><a href="#lbDU">АВТОРЫ</a></dt><dd>
</dd><dt><a href="#lbDV">ПЕРЕВОД</a></dt><dd>
</dd></dl>
<hr>
<br>
<form method="get" action="/search.shtml">
<font size="-1">
<font color="#555555">Поиск по тексту MAN-ов:&nbsp;</font><input size="30" name="words" value="iptables" type="text">
<input name="restrict" value="/man" type="hidden">
<input value="Найти" type="submit">
</font>
<input name="method" value="and" type="hidden">
<input name="format" value="builtin-long" type="hidden">
<input name="sort" value="score" type="hidden">
</form>
<br>
<!--htdig_noindex-->
<noindex>
<br>


</noindex>
<!--/htdig_noindex-->


<!-- footer -->
<!--htdig_noindex-->
<br><br>
<div style="background-color: #E9EAD6; width:100%; height: 61px;">
<div style="margin-right: 20px; float:left; line-height: 61px; vertical-align: middle; margin-left: 10px; font-size: 120%;">
Спонсоры:
</div>
<div style="float:left; height: 60px;  line-height: 60px; margin-left: 20px;">
<a style="align: middle;" target="_blank" href="https://inferno.name/"><img src="/img/inferno2.png" alt="Inferno Solutions" height="57" width="200"></a>
</div>
<div style="float:right; height: 60px;  line-height: 60px;  margin-left: 15px;">
<a style="align: middle;" target="_blank" href="http://hoster.ru/?utm_source=site&amp;utm_medium=banner&amp;utm_campaign=opennet"><img src="/img/dh143x60t.png" alt="Hosting by Hoster.ru" height="60" width="143"></a>
</div>
<div style="float:right;  height: 60px;  line-height: 60px; vertical-align: middle;font-size: 120%;">
Хостинг:
</div>

</div>

<div style="clear: both;"></div>


<br>
<table class="ttxt" style="border-top: 3px solid #C9CaB6;">
<tbody><tr><td width="35%">
<a href="/cgi-bin/opennet/bookmark.cgi">Закладки на сайте</a><br>
<a href="/cgi-bin/opennet/bookmark.cgi?submit=add" target="blank_">Проследить за страницей</a>
</td>
<td align="RIGHT" width="65%">
Created&nbsp;1996-2021&nbsp;by <b><a href="/contact.shtml" title="email maxim.chirkov@gmail.com">Maxim&nbsp;Chirkov</a></b><br>
<a href="https://www.opennet.ru/add.shtml">Добавить</a>, <a href="https://www.opennet.ru/donate.shtml" style="color: #C00000;">Поддержать</a>, <a href="https://www.opennet.ru/banners2.shtml">Вебмастеру</a>
</td>
</tr>
</tbody></table>
<br><br>


<!--/htdig_noindex-->
<!-- end of footer -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-123449-1', 'auto');
    ga('send', 'pageview');
</script>




</body>
<!---------------------------------------------  0  ---------------------------------------------->
