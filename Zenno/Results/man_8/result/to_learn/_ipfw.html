
<!--+++++++++++++++++++++++++++++++++++++++++++  0  +++++++++++++++++++++++++++++++++++++++++++--->
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<title>Проект OpenNet: MAN ipfw (8) Команды системного администрирования (FreeBSD и Linux)</title><meta name="KeyWords" content="man, manual, MAN, системное руководство, linux, FreeBSD, OpenBSD, Solaris, ядро, программы, системный вызов, ipfw"><meta name="viewport" content="width=device-width, initial-scale=1"></head>


<body link="#0000FF" vlink="#000080" text="#000000" bgcolor="#E3E4D0" alink="#FF00FF">
<link rel="stylesheet" href="/opennet4.css" type="text/css">
<!--htdig_noindex-->
<form method="get" action="https://www.opennet.ru/search.shtml">
<aside>
<div style="width: 100%; text-align: right; font-size: 70%; background: #E9EAD6; margin-bottom:-10px;">
Профиль: <b><a href="/~" rel="nofollow" title="/~ - сводная страница участника"><u>Аноним</u></a></b> (<a href="https://www.opennet.ru/cgi-bin/openforum/vsluhboard.cgi?az=login">вход</a> | <a href="https://www.opennet.ru/cgi-bin/openforum/vsluhboard.cgi?az=user_register">регистрация</a>)</div>

<table cellspacing="0" cellpadding="0" width="100%" border="0">
<tbody><tr>
<td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left" valign="BOTTOM" bgcolor="#E9EAD6" width="300">
<a href="https://www.opennet.ru/"><img src="/opennet2.gif" alt="The OpenNET Project" height="60" width="249" border="0"></a><br>
</td>
<td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left" bgcolor="#E9EAD6" align="CENTER" width="100">

</td><td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left;padding-bottom:10px;" bgcolor="#E9EAD6" align="CENTER" width="50%">
<table width="100%" border="0">
<tbody><tr>
<td width="22%">
 <a href="https://www.opennet.ru/opennews/" class="h"><b>НОВОСТИ</b></a> (<a href="https://www.opennet.ru/news/opennet.shtml" class="h">+</a>)
</td><td width="18%%">
  <a href="https://www.opennet.ru/mp/" class="h"><b>КОНТЕНТ</b></a>
</td><td width="14%">
  <a href="http://wiki.opennet.ru" class="h"><b>WIKI</b></a>
</td><td width="14%">
   <a href="https://www.opennet.ru/man.shtml" class="h"><b>MAN'ы</b></a>
</td><td width="16%">
   <a href="https://www.opennet.ru/forum/" class="h"><b>ФОРУМ</b></a>
</td><td width="16%">
<a href="https://www.opennet.ru/search.shtml" class="h" onmouseover="document.getElementById('form12').style.display='block';">Поиск</a>&nbsp;(<a href="https://www.opennet.ru/keywords/" class="h">теги</a>)
<input id="form12" style="display: none;" size="10" name="words" value="" title="для поиска в google наберите &quot;g фраза&quot;" type="text">
</td></tr>
</tbody></table>

</td><td style="background: #E9EAD6 url('/back.gif') repeat-x bottom left;padding-bottom:5px;" bgcolor="#E9EAD6" align="right" width="20%">

<a href="https://www.opennet.ru/opennews/opennews_all_utf.rss"><img src="/img/rss.png" alt="RSS" title="RSS" height="16" width="16" border="0"></a>&nbsp;<a href="https://twitter.com/opennetru"><img src="/twitter.png" alt="twitter" title="Twitter" height="16" width="16" border="0"></a>&nbsp;<a href="https://vk.com/opennet"><img src="/img/vkontakte.gif" title="ВКонтакте" height="16" width="16" border="0"></a>&nbsp;<a href="https://zen.yandex.ru/opennet"><img src="/img/zen.gif" title="Yandex Zen" height="16" width="16" border="0"></a>&nbsp;<a href="https://www.facebook.com/OpenNet.News/"><img src="/img/facebook.gif" title="Facebook" height="16" width="16" border="0"></a>&nbsp;<a href="https://telegram.space/opennet_ru"><img src="/img/telegram2.png" title="Telegram" height="16" width="16" border="0"></a>
</td></tr></tbody></table>
</aside>

<style>
    .hdr_mobile {
	text-align: center; 
	display: none;
	margin: 0px;
	padding: 0px;
    }
</style>
<div class="hdr_mobile">
<div style="margin-left: auto; margin-right: auto; width: 100%; height: 70px; border:1px solid #b0b190; min-width: 360px; max-width: 600px; background: #E9EAD6 url('/back.gif') repeat-x bottom left;">
<div style="float:left; width: 249px; height: 60px; margin-top: 10px;">
<a href="https://www.opennet.ru"><img src="/opennet2_lite.gif" style="height: 60px; width: 249px; border: 1px;" alt="The OpenNET Project / Index page"></a>
</div>
<div style="float: left; text-align: center; height: 70px; width: 331px; padding: 5px; margin-left: 10px;">
<br><small>[ <a href="/opennews/">новости</a>&nbsp;/<a href="/opennews/?full_lines=15&amp;lines=15&amp;mid_lines=00">+++</a> | <a href="/forum/">форум</a> | <a href="http://wiki.opennet.ru">wiki</a> | <a href="/keywords/">теги</a>
| <a href="tg://resolve?domain=opennet_ru"><img src="/img/telegram2.png" title="Telegram" style="margin-bottom: -4px;" height="16" width="16" border="0"></a>
]</small>
</div>
</div>
</div>
<div style="clear: both;"></div>


<div style="float: left; width: 279; text-align: left;padding-right: 60px;" id="adv">
</div>
<div style="padding-top: 0px;position:absolute;left:50%;margin-left:-235px;width:470px;" id="adv2">
</div>
<div style="width: 279;float: right;" id="adv3">
</div>
<div style="clear: both;"></div>
<br>
</form>
<!--/htdig_noindex-->

<center><h3><font color="#000088">Интерактивная система просмотра системных руководств (man-ов)</font></h3></center>
<form method="GET" action="/man.shtml"> 
<table cellspacing="0" cellpadding="1" bgcolor="#B0B190" align="center" width="600" border="0">
<tbody><tr>
<td valign="TOP">

<table cellspacing="0" cellpadding="0" bgcolor="#E9EAD6" align="center" width="100%" border="0">
<tbody><tr><td>&nbsp;<font color="#555555">Тема</font></td><td><font color="#555555">Набор</font></td><td><font color="#555555">Категория</font></td><td>&nbsp;</td></tr>
<tr><td>

&nbsp;<input size="20" name="topic" value="ipfw" type="text"></td><td><select name="russian">
<option value="4">Solaris man
</option><option value="1">FreeBSD man
</option><option value="3">Разные man
</option><option value="0" selected="">Русские man
</option><option value="2">Linux man
</option><option value="5">POSIX man
</option></select></td>
<td><select size="1" name="category">
	  <option value="" selected="">All
	  </option><option value="1">1
	  </option><option value="2">2
	  </option><option value="3">3
	  </option><option value="4">4
	  </option><option value="5">5
	  </option><option value="6">6
	  </option><option value="7">7
	  </option><option value="8">8
	  </option><option value="9">9
</option></select></td>

<td><input name="submit" value="Показать man" type="submit"></td></tr>
<script async="" src="https://www.google-analytics.com/analytics.js"></script><script language="JavaScript" src="/print.js"></script>
<tr><td colspan="4" align="left">&nbsp;[<a href="/man.shtml">Cписок руководств</a> | <a href="#" onclick="pr('none');">Печать</a>]</td></tr>
</tbody></table>
</td></tr></tbody></table>
</form>
<h3></h3><font size="+2">ipfw (8)</font><hr><li> <a href="/man.shtml?topic=ipfw&amp;category=4&amp;russian=1"><u>ipfw</u></a> (4) <font color="#555555"> ( FreeBSD man: Специальные файлы /dev/* )</font></li><li> <a href="/man.shtml?topic=ipfw&amp;category=4&amp;russian=2"><u>ipfw</u></a> (4) <font color="#555555"> ( Linux man: Специальные файлы /dev/* )</font></li><li> <a href="/man.shtml?topic=ipfw&amp;category=8&amp;russian=1"><u>ipfw</u></a> (8) <font color="#555555"> ( FreeBSD man: Команды системного администрирования )</font></li><li>&gt;&gt; <a href="/man.shtml?topic=ipfw&amp;category=8&amp;russian=0"><u>ipfw</u></a> (8) <font color="#555555"> ( Русские man: Команды системного администрирования )</font></li><li><font color="#555555">Ключ <a href="/keywords/ipfw.html"><u>ipfw</u></a> обнаружен в базе ключевых слов.</font></li>
<table width="100%" border="0">
<tbody><tr>
<td><h1>ipfw(8)</h1></td>
<td><h2 align="center">Руководство системного администратора FreeBSD</h2></td>
<td><h1 align="right">ipfw(8)</h1></td>
</tr>
</tbody></table>

<h2><a name="name">НАЗВАНИЕ</a></h2>

<p><b>ipfw</b> - <i>межсетевой экран</i> (<i>брандмауэр</i>) IP и программа
управления профилем передаваемой информации</p>

<h2><a name="synopsis">СИНТАКСИС</a></h2>
<dl><dt></dt><dd><tt>
ipfw [-q] [-p <b>препроцессор</b> [-D <b>макрос</b>[=<b>значение</b>]] [-U <b>макрос</b>]] <b>полное_имя_файла</b><br>
ipfw [-f | -q] flush<br>
ipfw [-q] {zero | resetlog | delete} [<b>число</b> ...]<br>
ipfw [-s [<b>поле</b>]] [-aftN] {list | show} [<b>число</b> ...]<br>
ipfw [-q] add [<b>число</b>] <b>тело_правила</b><br>
ipfw pipe <b>число</b> config <b>опции_конфигурирования_канала</b><br>
ipfw pipe {delete | list | show} [<b>число</b> ...]<br>
ipfw queue <b>число</b> config <b>опции_конфигурирования_очереди</b><br>
ipfw queue {delete | list | show} [<b>число</b> ...]
</tt></dd></dl>

<h2><a name="description">ОПИСАНИЕ</a></h2>

<p><b>ipfw</b> - это пользовательский интерфейс для управления брандмауэром
<b><a href="/man.shtml?topic=ipfirewall&amp;category=4">ipfirewall(4)</a></b> и <i>формирователем трафика</i> (traffic shaper)
<b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b> в ОС FreeBSD.</p>

<p>К каждому входящему и исходящему пакету применяются правила <b>ipfw</b>. Если хост работает
как <i>шлюз</i> (gateway), пакеты, перенаправляемые шлюзом, обрабатываются программой <b>ipfw</b> дважды.
Если хост работает как мост (bridge), пакеты, перенаправляемые мостом, обрабатываются программой
<b>ipfw</b> один раз.</p>

<p>Конфигурация брандмауэра задается в виде списка пронумерованных правил, который просматривается для
каждого пакета пока не будет найдено соответствие - тогда выполняется заданное соответствующим 
правилом действие. В зависимости от действия и некоторых установок в системе, пакеты могут возвращаться 
на брандмауэр для обработки правилами, начиная со следующего за сработавшим. Все правила применяются
ко всем интерфейсам, так что задача написания набора правил с минимально необходимым
количеством проверок возлагается на системного администратора.</p>

<p>Конфигурация всегда включает стандартное правило (<b>DEFAULT</b>) с номером 65535, которое
нельзя изменять и которое соответствует любому пакету. С этим стандартным правилом может
быть связано действие <b>deny</b> или <b>allow</b>, в зависимости от конфигурации ядра.</p>

<p>Если набор правил включает одно или несколько правил с опцией <b>keep-state</b>,
то программа <b>ipfw</b> предполагает работу <i>с сохранением состояния</i> (stateful behaviour),
т.е. при успешном сопоставлении будет создавать динамические правила, соответствующие
конкретным параметрам (адресам и портам) сопоставившегося пакета.</p>

<p>Эти динамические правила с ограниченным временем существования проверяются, начиная с первого
вхождения правила <b>check-state</b> или <b>keep-state</b>, и обычно используются для
приоткрытия брандмауэра по требованию только для допустимого трафика. Подробнее о работе 
программы <b>ipfw</b> с сохранением состояния см. далее в разделах
<a href="#rule_format"><b>ФОРМАТ ПРАВИЛА</b></a> и <a href="#examples"><b>ПРИМЕРЫ</b></a>.</p>

<p>Со всеми правилами (включая динамические) связано несколько счетчиков: счетчик пакетов,
счетчик байтов, счетчик журнала (log count) и временная отметка (timestamp), хранящая время
последнего сопоставления. Счетчики можно выдать или сбросить с помощью команд <b>ipfw</b>.</p>

<p>Правила добавляются с помощью команды <b>add</b>; удаляются по одному -
с помощью команды <b>delete</b>, и все сразу - с помощью команды <b>flush</b>; 
выдаются, в том числе, возможно, со значениями счетчиков, с помощью команд <b>show</b> и 
<b>list</b>. Наконец, значения счетчиков можно сбросить с помощью команд <b>zero</b> и <b>resetlog</b>.</p>

<p>Поддерживаются следующие опции:</p>

<dl>
<dt><a name="a"><b>-a</b></a></dt><dd>
Выдавать значения счетчиков вместе с правилами. См. также описание команды <b>show</b>.
<br><br></dd>
<dt><a name="f"><b>-f</b></a></dt><dd>
Не запрашивать подтверждения для команд, которые при неправильном использовании могут вызвать проблемы,
например, <b>flush</b>. Учтите, что если процесс не связан с терминалом, эта опция подразумевается.<br><br></dd>
<dt><a name="q"><b>-q</b></a></dt><dd>
При добавлении, обнулении, сбросе журнала или списка правил не выдавать информации о действиях 
(эта опция подразумевает опцию <b>-f</b>). Это полезно при настройке списка правил
с помощью нескольких команд <b>ipfw</b> в сценарии (например, <b>sh /etc/rc.firewall</b>),
или при обработке файла с несколькими правилами <b>ipfw</b> в сеансе с удаленной регистрацией.
Если команда <b>flush</b> выполняется в обычном (информативном) режиме (в стандартной конфигурации
ядра), она выдает сообщение. Поскольку все правила сбрасываются, сообщение это не может быть
передано сеансу. В результате, сеанс с удаленной регистрацией закрывается и остальные правила не
обрабатываются. Для восстановления придется зарегистрироваться с консоли.<br><br></dd>
<dt><a name="t"><b>-t</b></a></dt><dd>
При выдаче правиил указывать временную отметку последнего сопоставления.<br><br></dd>
<dt><a name="N"><b>-N</b></a></dt><dd>
При выдаче пытаться разрешать адреса и имена служб.<br><br></dd>
<dt><a name="s"><b>-s</b> [<b>поле</b>]</a></dt><dd>
При выдаче каналов, сортировать в соотетствии с одним из четырех счетчиков
(общее/текущее количество пакетов или байтов).</dd>
</dl>

<p>Для упрощения конфигурирования правила можно помещать в файл, который обрабатывается 
с помощью команды <b>ipfw</b> как показано в первой строке синтаксиса.
Необходимо указывать полное имя файла. Файл будет читаться построчно и строки
применяются как аргументы вызова утилиты <b>ipfw</b>.</p>

<p>Можно также указать препроцессор (с помощью конструкции <b>-p препроцессор</b>), через 
который будет пропущен заданный файл. Пригодятся препроцессоры <b><a href="/man.shtml?topic=cpp&amp;category=1">cpp(1)</a></b> и
<b><a href="/man.shtml?topic=m&amp;category=4">m4(1)</a></b>. Если параметр <b>препроцессор</b> не начинается 
с косой черты ('<b>/</b>'), выполняется обычный поиск с учетом значения переменной
среды <b>PATH</b>. Это надо учитывать в средах, где не все файловые системы еще смонтированы в
момент выполнения команды <b>ipfw</b> (например, если они монтируются по NFS).
Если была указана опция <b>-p</b>, можно также задавать спецификации <b>-D</b> и <b>-U</b>,
которые будут передаваться препроцессору. Это позволяет создавать гибкие файлы
конфигурации (например, включающие зависимости от имени локального хоста) и 
использовать макросы для часто используемых аргументов вроде IP-адресов.</p>

<p>Команды <b>ipfw</b> <b>pipe</b> используются для конфигурирования формирователя трафика,
как описано в разделе <a href="#shaper"><b>КОНФИГУРИРОВАНИЕ ФОРМИРОВАТЕЛЯ ТРАФИКА</b></a> ниже.</p>

<h2><a name="rule_foprmat">ФОРМАТ ПРАВИЛ</a></h2>

<p>Правила <b>ipfw</b> имеют следующий формат:</p>

[prob <b>вероятность_сопоставления</b>] <b>действие</b> [log [logamount <b>число</b>]]
<b>протокол</b> from <b>исходный_адрес</b> to <b>целевой_адрес</b> [<b>спецификация_интерфейса</b>] [<b>опции</b>]

<p>Каждый пакет можно фильтровать на основе следующей, связанной с ним информации:</p>

<ul>
<li>Интерфейс передачи и приема (по имени или адресу)</li>
<li>Направление (входящий или исходящий)</li>
<li>Исходный и целевой IP-адреса (возможно, замаскированные)</li>
<li>Протокол (TCP, UDP, ICMP и т.п.)</li>
<li>Исходный и целевой порт (можно указывать списки, диапазоны или маски)</li>
<li>Флаги TCP</li>
<li>Флаг IP-фрагмента</li>
<li>Опции IP</li>
<li>Типы ICMP</li>
<li>Идентификатор пользователя/группы для сокета, связанного с пакетом</li>
</ul>

<p>Учтите, что фильтровать пакеты на основе исходного IP-адреса или исходного порта TCP/UDP
небезопасно, поскольку адрес и номер порта легко подделать.</p>

<dl>
<dt><b>prob вероятность_сопоставления</b></dt><dd>
Сопоставление происходит только с заданной вероятностью (вещественное число в диапазоне от 0 до 1).
Эта возможность может пригодиться для различных целей, например, для случайной потери пакетов
или (при использовании совместно с <a href="/man.shtml?topic=dummynet&amp;category=4"><b>dummynet(4)</b></a>) для
имитации эффекта доставки пакетов в другом порядке из-за использования нескольких путей.
<br><br></dd>
<dt><b>действие</b>:</dt><dd>
<dl>   
<dt><b><a name="allow">allow</a></b></dt><dd>
Пропускать пакеты, соответствующие правилу. Дальнейший поиск прекращается.
У этого действия есть псевдонимы: <b>pass</b>, <b>permit</b> и <b>accept</b>.
<br><br></dd>
<dt><b><a name="deny">deny</a></b></dt><dd>
Отвергать пакеты, соответствующие правилу. Дальнейший поиск прекращается. 
У этого действия есть псевдоним - <b>drop</b>.
<br><br></dd>
<dt><b><a name="reject">reject</a></b></dt><dd>
(Не рекомендуется). Отвергать пакеты, соответствующие этому правилу, и пытаться
посылать уведомление о недостижимости хоста по протоколу ICMP. Дальнейший поиск прекращается.
<br><br></dd>
<dt><b><a name="unreach">unreach код</a></b></dt><dd>
Отвергать пакеты, соответствующие этому правилу, и пытаться посылать уведомление
о недостижимости по протоколу ICMP с указанным <b>кодом</b>, где <b>код</b> -
число от 0 до 255 или один из следующих псевдонимов: <b>net</b>, <b>host</b>,
<b>protocol</b>, <b>port</b>, <b>needfrag</b>, <b>srcfail</b>, <b>net-unknown</b>,
<b>host-unknown</b>, <b>isolated</b>, <b>net-prohib</b>, <b>host-prohib</b>, <b>tosnet</b>,
<b>toshost</b>, <b>filter-prohib</b>, <b>host-precedence</b> или
<b>precedence-cutoff</b>. Дальнейший поиск прекращается. 
<br><br></dd>
<dt><b><a name="reset">reset</a></b></dt><dd>
Только для TCP-пакетов.	Отвергать пакеты, соответствующие этому правилу, и попытаться послать
уведомление TCP <b>reset</b> (RST).	Дальнейший поиск прекращается.
<br><br></dd>
<dt><b><a name="count">count</a></b></dt><dd>
Обновить счетчики для всех пакетов, соответствующих правилу. Поиск продолжается со
следующего правила.
<br><br></dd>
<dt><b><a name="check-state">check-state</a></b></dt><dd>
Проверяет пакет по динамическому набору правил. Если найдено соответствие, дальнейший
поиск прекращается, иначе - переходим к следующему правилу.  Если 
правило <b>check-state</b> не найдено, динамический набор правил проверяется
с первого правила <b>keep-state</b>.
<br><br></dd>
<dt><b><a name="divert">divert порт</a></b></dt><dd>
Перенаправляет пакеты, соответствующие правилу, на сокет <b><a href="/man.shtml?topic=divert&amp;category=4">divert(4)</a></b>,
связанный с указанным <b>портом</b>. Дальнейший поиск прекращается.
<br><br></dd>
<dt><b><a name="tee">tee порт</a></b></dt><dd>
Посылает копию пакетов, соответствующих правилу, на сокет 
<b><a href="/man.shtml?topic=divert&amp;category=4">divert(4)</a></b>, связанный с указанным <b>портом</b>.
Дальнейший поиск прекращается и исходный пакет принимается (см., однако,
раздел <a href="#bugs"><b>ОШИБКИ</b></a> далее).
<br><br></dd>
<dt><b><a name="fwd">fwd ip-адрес[,порт]</a></b></dt><dd>
Изменяет следующий переход (next-hop) для соответствующих пакетов, направляя
их по указанному <b>ip-адресу</b>, который можно задавать либо в виде четверки
чисел через точку, либо по имени хоста. Если <b>ip-адрес</b> непосредственно не
доступен, вместо него используется соответствующий маршрут, полученный 
по локальной таблице маршрутизации. Если <b>ip-адрес</b> - локальный,
при поступлении в систему пакета с удаленного хоста он будет перенаправлен
на заданный <b>порт</b> на локальной машине, так что локальный адрес сокета
остается установленным в соответствии с исходным IP-адресом, по которому
направлялся пакет. Это действие предназначено для использования в 
прозрачных промежуточных серверах. Если IP-адрес - не локальный, дальнейший поиск 
прекращается; однако, при выходе из канала если переменная 
<b><a href="/man.shtml?topic=sysctl&amp;category=8">sysctl(8)</a></b> <b>net.inet.ip.fw.one_pass</b> не
установлена, пакет снова передается брандмауэру для проверки, начиная
со следующего правила.
<br><br></dd>
<dt><b><a name="queue">queue номер_очереди</a></b></dt><dd>
Передает пакет в "очередь" <b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b>
(для ограничения пропускной способности с помощью WF2Q).
<br><br></dd>
<dt><b><a name="skipto">skipto номер</a></b></dt><dd>
Пропускает все последующие правила с номерами меньше указанного. Поиск продолжается
с первого правила, номер которого равен указанному или больше его.</dd>
</dl>
</dd>
<dt><b>log</b> [<b>logamount количество</b>]</dt><dd>
Если ядро было скомпилировано с опцией <b>IPFIREWALL_VERBOSE</b>, то когда пакет
соответствует правилу с ключевым словом <b>log</b> в журнал с помощью демона 
<b><a href="/man.shtml?topic=syslogd&amp;category=8">syslogd(8)</a></b> записывается сообщение от 
источника <b>LOG_SECURITY</b>. <i>Примечание</i>: по умолчанию, сообщения 
добавляются в файл <b>/var/log/security</b> (см. 
<b><a href="/man.shtml?topic=syslog.conf&amp;category=5">syslog.conf(5)</a></b>). Если ядро было скомпилировано
с опцией <b>IPFIREWALL_VERBOSE_LIMIT</b>, то по умолчанию журнализация
прекратится после того, как заданное в этой опции количество пакетов будет получено
соответствующим правилом в цепочке, и параметр <b>net.inet.ip.fw.verbose_limit</b> 
будет установлен равным указанному количеству. Однако, если используется опция
<b>logamount количество</b>, именно это <b>количество</b> будет ограничивать
записываемые в журнал пакеты, а не <b>net.inet.ip.fw.verbose_limit</b>, причем, значение
"0" снимает ограничение на количество записей в журнал. Затем журнализацию можно 
включить повторно путем сброса ограничения или счетчика пакетов для соответствующей записи.

<p>Журнализация на консоль и ограничение количества записей в журнал настраивается
динамически с помощью интерфейса <b><a href="/man.shtml?topic=sysctl&amp;category=8">sysctl(8)</a></b> 
в базе MIB <b>net.inet.ip.fw</b>.</p>
</dd>
<dt><b>протокол</b></dt><dd>
IP-протокол, заданный по номеру или по имени (полный список см. в файле <b>/etc/protocols</b>).
Ключевые слова <b>ip</b> или <b>all</b> обозначают, что подходит любой протокол.
<br><br></dd>
<dt><b>исходный_адрес</b> и <b>целевой_адрес</b>:</dt><dd>

<tt><b>any</b> | <b>me</b> | [<b>not</b>] &lt;<b>адрес</b>/<b>маска</b>&gt; [<b>порты</b>]</tt>

<p>Если указать <b>any</b>, правилу будет соответствовать любой IP-адрес.</p>

<p>Если указать <b>me</b>, правилу будет соответствовать любой IP-адрес, сконфигурированный на 
любом из интерфейсов системы. Эта проверка требует достаточно много вычислительных ресурсов
и ее надо использовать осторожно.</p>

<p>&lt;<b>адрес</b>/<b>маску</b>&gt; можно задавать в следующем виде:</p>

<dl>
<dt><b>ipno</b></dt><dd>
IP-адрес в виде четверки чисел через точку, например, <b>1.2.3.4</b>. Правилу будет соответствовать
только этот IP-адрес.</dd>
<dt><b>ipno/bits</b></dt><dd>
IP-адрес в виде четверки чисел через точку плюс размер маски в битах, например, <b>1.2.3.4/24</b>.
В данном случае соответствовать будут все IP-адреса в диапазоне от <b>1.2.3.0</b> до <b>1.2.3.255</b>.</dd>
<dt><b>ipno:mask</b></dt><dd>
IP-адрес в виде четверки чисел с маской через точку в виде четверки чисел через точку,
например, <b>1.2.3.4:255.255.240.0</b>. В данном случае соответствовать будут все IP-адреса
в диапазоне от <b>1.2.0.0</b> до <b>1.2.15.255</b>.
</dd></dl>

<p>Можно потребовать, чтобы правилу соответствовали все адреса, кроме указанных, добавив
перед адресом модификатор <b>not</b>. Этот модификатор не влияет на
выбор по номерам портов.</p>

<p>Для протоколов TCP и UDP можно также дополнительно указать порты в виде:</p>

<dl><dt></dt><dd><tt>
{<b>порт</b>|<b>порт</b>-<b>порт</b>|<b>порт</b>:<b>маска</b>}[,<b>порт</b>[,...]]
</tt></dd></dl>

<p>Дефис (<b>-</b>) позволяет задать диапазон портов (включая границы).</p>

<p>Двоеточие (<b>:</b>) позволяет задать порт и маску - пакет считается соответствующим
правилу, если номер порта в нем соответствует указанному в правиле с точностью до битов,
установленных в маске.</p>

<p>Вместо числовых значений портов можно указать имена служб (из файла <b>/etc/services</b>).
Диапазон можно указывать только в качестве первого элемента списка, а длина списка портов
ограничена значением <b>IP_FW_MAX_PORTS</b> (которое задано в заголовочном файле 
<b>/usr/src/sys/netinet/ip_fw.h</b>). Обратная косая (<b>\</b>) позволяет замаскировать
дефис (<b>-</b>) в имени службы:</p>

<dl><dt></dt><dd><tt>
ipfw add count tcp from any ftp\\-data-ftp to any
</tt></dd></dl>

<p>Фрагментированные пакеты с ненулевым смещением (т.е. не первый фрагмент)
никогда не будут соответствовать правилу, в котором задан один или несколько портов.
Подробнее о сопоставлении фрагментированных пакетов см. в описании опции 
<a href="#frag"><b>frag</b></a>.</p>
</dd>
<dt><b>спецификация_интерфейса</b></dt><dd>
Можно указывать комбинации следующих спецификаций:

<dl>
<dt><b>in</b></dt><dd>
Соответствует только входящим пакетам.<br><br></dd>
<dt><b>out</b></dt><dd>
Соответствует только исходящим пакетам.<br><br></dd>
<dt><b>via <i>ifX</i></b></dt><dd>
Пакет должен пройти через интерфейс <b><i>ifX</i></b>.<br><br></dd>
<dt><b>via <i>if*</i></b></dt><dd>
Пакет должен пройти через интерфейс <b><i>ifX</i></b>, где <b><i>X</i></b> - любой номер
устройства.<br><br></dd>
<dt><b>via any</b></dt><dd>
Пакет должен пройти через <i>любой</i> интерфейс.
<br><br></dd>
<dt><b>via <i>ipno</i></b></dt><dd>
Пакет должен пройти через интерфейс с IP-адресом <b>ipno</b>.</dd>
</dl>

Ключевое слово <b>via</b> приводит к обязательной проверке интерфейса. Если
вместо <b>via</b> использовано ключевое слово <b>recv</b> или <b>xmit</b>,
то проверяется только интерфейс получения или интерфейс передачи, соответственно.
Задав оба этих ключевых слова, можно отбирать пакеты на основе обоих интерфейсов,
получения и отправки, например:

<dl><dt></dt><dd><tt>
ipfw add 100 deny ip from any to any out recv ed0 xmit ed1
</tt></dd></dl>

<p>Интерфейс <b>recv</b> можно проверять на входящие и исходящие пакеты,
а интерфейс <b>xmit</b> - только на исходящие пакеты. Поэтому ключевое
слово <b>out</b> - обязательно (а <b>in</b> - недопустимо), если используется
<b>xmit</b>. Указывать <b>via</b> вместе с <b>xmit</b> или <b>recv</b> нельзя.</p>
		
<p>Пакет может не иметь интерфейса получения или передачи: пакеты, поступающие
с локального хоста, не имеют интерфейса получения, а пакеты, предназначенные
для локального хоста, не имеют интерфейса передачи.</p>
</dd>
<dt><b>опции</b>:</dt><dd>

<dl>
<dt><a name="keep-state"><b>keep-state [<i>метод</i>]</b></a></dt><dd>
При сопоставлении брандмауэр создаст динамическое правило, по умолчанию 
соответствующее двунаправленному обмену данными между исходным и
целевым IP-адресом/портом по тому же самому протоколу.
Это правило имеет ограниченное время существования (определяемое 
набором переменных <b>sysctl(8)</b>), и это время изменяется при
выявлении каждого соответствующего пакета.

<p>Фактическое поведение можно изменить, задав другой <b><i>метод</i></b>.</p>
</dd>
<dt><a name="bridged"><b>bridged</b></a></dt><dd>
Соответствует только пакетам, прошедшим через мост. Это может пригодиться
для отбора пакетов многоадресной или широковещательной передачи, которые
в противном случае будут проходить через брандмауэр дважды: один раз при
прохождении через мост, а второй - когда пакет попадает в локальный стек.

<p>Помимо небольшого снижения производительности, это приводит к проблемам
при использовании <i>каналов</i>, поскольку один и тот же пакет будет учитываться
дважды при определении пропускной способности (bandwidth),
использования очередей и при изменении счетчиков.</p>
</dd>
<dt><a name="frag"><b>frag</b></a></dt><dd>
Соответствует пакету, являющемуся не первым фрагментом датаграммы. Опцию <b>frag</b>
нельзя использовать в сочетании с <b>tcpflags</b> или спецификациями порта TCP/UDP.
<br><br></dd>
<dt><a name="ipoptions"><b>ipoptions <i>спецификация</i></b></a></dt><dd>
Соответствует пакету, если его IP-заголовок содержит указанный в <i><b>спецификации</b></i>
список оцпий через запятую. Поддерживаются следующие опции IP:

<p><b>ssrr</b> (strict source route), <b>lsrr</b> (loose source route), <b>rr</b>
(record packet route) и <b>ts</b> (timestamp). Отсутствие определенной опции
может обозначаться восклицательным знаком (<b>!</b>).</p>
</dd>
<dt><a name="tcpoptions"><b>tcpoptions <i>спецификация</i></b></a></dt><dd>
Соответствует пакету, если его TCP-заголовок содержит указанный в <i><b>спецификации</b></i>
список оцпий через запятую. Поддерживаются следующие опции TCP:

<p><b>mss</b> (maximum segment size - максимальный размер сегмента), <b>window</b> 
(tcp window advertisement - предлагаемое окно tcp), <b>sack</b> 
(selective ack - избирательное подтверждение), <b>ts</b> 
(rfc1323 timestamp - временная отметка по стандарту RFC 1323) и
<b>cc</b> (rfc1644 t/tcp connection count - счетчик подключения по стандарту RFC 1644).
Отсутствие определенной опции может обозначаться восклицательным знаком (<b>!</b>).</p>
</dd>
<dt><a name="established"><b>established</b></a></dt><dd>
Только для TCP-пакетов.	Соответствует пакетам с установленными битами <b>RST</b>
или <b>ACK</b>.<br><br></dd>
<dt><a name="setup"><b>setup</b></a></dt><dd>
Только для TCP-пакетов.	Соответствует пакетам с установленным битом <b>SYN</b>, но
со сброшенным битом <b>ACK</b>.<br><br></dd>
<dt><a name="tcpflags"><b>tcpflags <i>спецификация</i></b></a></dt><dd>
Только для TCP-пакетов.	Соответствует пакету, если его TCP-заголовок содержит
заданный в <i><b>спецификации</b></i> список флагов через запятую.
Поддерживаются следующие флаги TCP:

<p><b>fin</b>, <b>syn</b>, <b>rst</b>, <b>psh</b>, <b>ack</b> и <b>urg</b>.
Отсутствие определенной опции может обозначаться восклицательным знаком (<b>!</b>).
Правило, содержащее спецификацию <b>tcpflags</b>, не может сопоставиться
с фрагментированным пакетом, имеющим ненулевое смещение. Подробнее о
сопоставлении фрагментированных пакетов см. в описании опции <a name="#frag"><b>frag</b></a>.</p>
</dd>
<dt><a name="icmptypes"><b>icmptypes <i>типы</i></b></a></dt><dd>
Только для пакетов ICMP. Соответствует пакету, если его ICMP-тип входит в указанный
список типов. Список можно задавать как любую комбинацию диапазонов
или отдельных типов через запятые. Поддерживаются следующие ICMP-типы:

<p>echo reply (<b>0</b>, эхо-ответ), destination unreachable (<b>3</b>, целевой
адрес недоступен), source quench (<b>4</b>), redirect (<b>5</b>, перенаправление),
echo request (<b>8</b>, эхо-запрос), router advertisement (<b>9</b>, 
представление маршрутизатора), router solicitation (<b>10</b>), 
time-to-live exceeded (<b>11</b>, превышено время существования), 
IP header bad (<b>12</b>, неверный IP-заголовок), timestamp request (<b>13</b>,
запрос временной отметки), timestamp reply (<b>14</b>, временная отмета в ответ), 
information request (<b>15</b>, запрос информации), information reply (<b>16</b>,
ответ на запрос информации), address mask request (<b>17</b>, запрос маски адреса) и
address mask reply (<b>18</b>, маска адреса в ответ).</p>
</dd>
<dt><a name="uid"><b>uid <i>пользователь</i></b></a></dt><dd>
Соответствует всем TCP- или UDP-пакетам, посланным или полученным указанным 
<b><i>пользователем</i></b>. <b><i>Пользователя</i></b> можно задавать по имени
или с помощью числового идентификатора.
<br><br></dd>
<dt><a name="gid"><b>gid <i>группа</i></b></a></dt><dd>
Соответствует всем TCP- или UDP-пакетам, посланным или полученным для
указанной <b><i>группы</i></b>. <b><i>Группу</i></b> можно задавать
по имени или с помощью числового идентификатора.
</dd></dl>
</dd>
</dl>

<h2><a name="traffic_shaper">КОНФИГУРАЦИЯ ФОРМИРОВАТЕЛЯ ТРАФИКА</a></h2>

<p>Утилита <b>ipfw</b> также обеспечивает пользовательский интерфейс для
формирователя трафика <b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b>.
Формирователь работает путем деления пакетов на <i>потоки</i> в соответствии
с заданной пользователем маской по различным полям заголовка IP. Пакеты,
принадлежащие к одному потоку, затем передаются двум различным объектам - 
<i>каналу</i> или <i>очереди</i>.</p>

<p><i>Канал</i> эмулирует связь с заданными пропускной способностью,
задержкой при передаче, размером очереди и процентом потери пакетов.
Пакеты проходят по каналу в соответствии с его параметрами.</p>

<p><i>Очередь</i> - абстракция, используемая для реализации правил WF2Q+. Очередь
связывает с каждым потоком вес и соответствующий канал. Далее, все потоки,
связанные с одним и тем же каналом, переключаются с частотой, определяемой
каналом в соответствии с правилами WF2Q+.</p>

<p>Формат конфигурации канала <b>ipfw</b> следующий:</p>

<p><b>pipe</b> <i>число</i> <b>config</b> 
[<b>bw</b> <i>пропускная_способность</i> | <i>устройство</i>] 
[<b>delay</b> <i>задержка_в_миллисекундах</i>] 
[<b>queue</b> {<i>слоты</i> | <i>размер</i>}] 
[<b>plr</b> <i>вероятность_потери</i>] [<b>mask</b> <i>спецификатор_маски</i>]
[<b>buckets</b> <i>размер_хеш-таблицы</i>] 
[<b>red</b> | <b>gred</b> <i>w_q</i>/<i>min_th</i>/<i>max_th</i>/<i>max_p</i>]
</p>

<p>Формат конфигурации очереди <b>ipfw</b> следующий:</p>

<p><b>queue</b> <i>число</i> <b>config</b> 
[<b>pipe</b> <i>номер_канала</i>] [<b>weight</b> <i>вес</i>] 
[<b>queue</b> {<i>слотов</i> | <i>размер</i>}]
[<b>plr</b> <i>вероятность_потери</i>] [<b>mask</b> <i>спецификатор_маски</i>] 
[<b>buckets</b> <i>размер_хеш-таблицы</i>]
[<b>red</b> | <b>gred</b> <i>w_q</i>/<i>min_th</i>/<i>max_th</i>/<i>max_p</i>]
</p>

<p>Для канала можно сконфигурировать следующие параметры:</p>

<dl>
<dt><b>bw <i>пропускная_способность</i></b> | <b><i>устройство</i></b></dt><dd>
Пропускная способность, измеренная в [<b>K</b>|<b>M</b>]{<b>bit/s</b>|<b>byte/s</b>}.

<p>Значение 0 (принятое по умолчанию) означает неограниченную пропускную
способность. Единицу измерения необходимо указывать сразу после
числового значения, например:</p>
<dl><dt></dt><dd><tt>
		   ipfw pipe 1 config bw 300Kbit/s queue 50KBytes
</tt></dd></dl>
Если вместо числового значения указано имя устройства, то скорость передачи
задается указанным устройством. В настоящее время только устройство <b>tun(4)</b>
поддерживает такую возможность, для использования совместно с <b>ppp(8)</b>.
<br><br></dd>
<dt><b>delay <i>задержка_в_миллисекундах</i></b></dt><dd>
Задержка при передаче, задаваемая в миллисекундах. Значение округляется
до следующего кратного минимальному временному интервалу системных часов
(обычно - 10 миллисекунд, но обычно имеет смысл запускать ядра с опцией 
"options HZ=1000", чтобы можно было задавать время с точностью до 1 миллисекунды
или менее).	Стандартное значение, 0, означает отсутствие задержки.
<br><br></dd>
<dt><b>queue {<i>слотов</i> | <i>размер</i>Kbytes}</b></dt><dd>
Размер очереди, в <i>слотах</i> или <b>Kбайтах</b>. По умолчанию используется
50 слотов, что является типичным размером очереди для устройств Ethernet.
Учтите, что для низкоскоростных подключений следует использовать очереди небольшого
размера или при передаче будут возникать существенные задержки пакетов в очереди. Так,
50 пакетов ethernet максимального размера (1500 байтов) означает 600 Кбит, или
нахождение в очереди в течение 20 секунд для канала с пропускной способностью
30Kbit/s. Эффект может быть еще хуже, если пакеты принимаются с интерфейса с
намного большим значением MTU, например, с интерфейса закольцовывания с его
пакетами размером 16 Kбайт.
<br><br></dd>
<dt><b>plr <i>вероятность_потери</i></b></dt><dd>
Вероятность потери пакета. Аргумент <b><i>вероятность_потери</i></b> - вещественное
число от 0 до 1, так что 0 означает отсуствие потерь, а 1 - 100% потерю.  Вероятность
потери внутренне представлена 31 битом.
<br><br></dd>
<dt><b>mask <i>спецификатор_маски</i></b></dt><dd>
Интерфейс <b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b> позволяет создавать
отдельнЁе очереди для каждого потока. Идентификатор потока создается путем
маскировки IP-адресов, портов и типов протоколов, заданных в конфигурации
канала. Пакеты с одинаковым идентфикатором после маскировки попадают в одну
очередь. Спецификаторы маски строятся как комбинации следующих компонентов:
<b>dst-ip <i>маска</i></b>, <b>src-ip <i>маска</i></b>, <b>dst-port <i>маска</i></b>, 
<b>src-port <i>маска</i></b>, <b>proto <i>маска</i></b> или <b>all</b>,
что означает существенность всех битов во всех полях. При использовании
в конфигурации <i>канала</i>, каждому потоку присваивается частота (rate),
равная частоте канала. При использовании в конфигурации <i>очереди</i>,
каждый поток получает вес, равный весу очереди, и все потоки,
связанные с одним каналом, используют канал пропорционально их весу.<p></p>
<br><br></dd>
<dt><b>buckets</b> <i>размер_хеш-таблицы</i></dt><dd>
Задает размер хеш-таблицы, используемой для хранения различных очередей.
Стандартное значение, 64, задается переменной <b><a href="/man.shtml?topic=sysctl&amp;category=8">sysctl(8)</a></b>
<b>net.inet.ip.dummynet.hash_size</b>, и может быть в диапазоне от 16 до 1024.
<br><br></dd>
<dt><b>pipe <i>номер_канала</i></b></dt><dd>
Связывает очередь с указанным каналом. С одним каналом можно связать несколько
очередей (обычно, с разными весами), который задает суммарную скорость передачи для
набора очередей.
<br><br></dd>
<dt><b>weight <i>вес</i></b></dt><dd>
Задает вес, который будет использоваться для потоков, соответствующих данной очереди.
Вес должен быть в диапазоне 1..100, и имеет стандартное значение 1.
<br><br></dd>
<dt><b>red</b> | <b>gred <i>w_q</i>/<i>min_th</i>/<i>max_th</i>/<i>max_p</i></b></dt><dd>
Использует алгоритм управления очередью RED. <b><i>w_q</i></b> и <b><i>max_p</i></b> -
вещественные числа в диапазоне от 0 до 1 (не включая 0), а <b><i>min_th</i></b>
и <b><i>max_th</i></b> - целые числа, задающие пороговые значения
для алгоритма управления очередью (пороговые значения задаются в байтах,
если размер очереди задавался в байтах, и в слотах в противном случае). Интерфейс
<b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b> поддерживается также более
умеренную (gentle) версию RED (<b>gred</b>). Для управления работой
алгоритма RED можно использовать три переменных <b>sysctl(8)</b>:

<dl>
<dt><b>net.inet.ip.dummynet.red_lookup_depth</b></dt><dd>
задает точность при вычислении средней очереди, когда связь простаивает 
(стандартное значение - 256, должно быть больше нуля)<br><br></dd>
<dt><b>net.inet.ip.dummynet.red_avg_pkt_size</b></dt><dd>
задает ожидаемый средний размер пакета (стандартное значение - 512,
должно быть больше нуля)<br><br></dd>
<dt><b>net.inet.ip.dummynet.red_max_pkt_size</b></dt><dd>
задает ожидаемый максимальный размер пакета, который используется только когда
пороговые значения для очереди задаются в байтах (стандартное значение - 1500,
должно быть больше нуля).</dd>
</dl>
</dd>
</dl>

<h2><a name="checklist">СПИСОК ДЛЯ ПРОВЕРКИ</a></h2>

<p>При разработке правил надо учитывать следующие существенные моменты:</p>

<ul>
<li>Помните, что фильтруются как <b>входящие</b>, так и <b>исходящие</b> пакеты.
Для большинства подключений необходим двунаправленный обмен пакетами.</li>
<li>Помните о необходимости очень внимательно тестировать набор правил.
При этом крайне желателен доступ к консоли. Если консоль недоступна,
используйте сценарий автоматического восстановления типа
<b>/usr/share/examples/ipfw/change_rules.sh</b>.</li>
<li>Не забывайте про интерфейс закольцовывания (loopback interface).</li>
</ul>

<h2><a name="fine_points">ПОЛОЖИТЕЛЬНЫЕ МОМЕНТЫ</a></h2>

<ul>
<li>Одну разновидность пакетов брандмауэр отвергает всегда - это фрагмент
TCP-пакета со смещением один. Это допустимый пакет, но используется он с единственной
целью - для обходя брандмауэров. Если включена регистрация, такие пакеты
регистрируются как отвергнутые правилом -1.</li>
<li>При подключении по сети загрузка версии <b><a href="/man.shtml?topic=kld&amp;category=4">kld(4)</a></b>
утилиты <b>ipfw</b> не так проста, как может показаться. Я рекомендую использовать
следующую командную строку:

<dl><dt></dt><dd><pre>kldload /modules/ipfw.ko &amp;&amp; \
ipfw add 32000 allow ip from any to any
</pre></dd></dl>

В этой же ситуации выполнение команды

<dl><dt></dt><dd><pre>ipfw flush
</pre></dd></dl>

тоже не поможет.
</li>
<li>Список фильтров <b>ipfw</b> нельзя изменять если уровень защиты системы установлен
равным 3 или выше (подробнее об уровнях защиты системы см. на странице
справочного руководства <b><a href="/man.shtml?topic=init&amp;category=8">init(8)</a></b>).</li>
</ul>

<h2><a name="packet_diversion">ПЕРЕНАПРАВЛЕНИЕ ПАКЕТОВ</a></h2>

<p>Сокет <b><a href="/man.shtml?topic=divert&amp;category=4">divert(4)</a></b>, связанный с указанным
портом, будет получать все пакеты, перенаправленные на этот порт. Если
с целевым портом не связан ни один сокет или если ядро не было скомпилировано
с поддержкой сокетов перенаправления, пакеты удаляются.</p>

<h2><a name="sysctl">ПЕРЕМЕННЫЕ SYSCTL</a></h2>

<p>Набор переменных <b><a href="/man.shtml?topic=sysctl&amp;category=8">sysctl(8)</a></b> управляет поведением
брандмауэра. Стандартные значения и описания этих переменных представлены далее:</p>

<dl>
<dt><b>net.inet.ip.fw.debug</b>: 1</dt><dd>
Управляет отладочными сообщениями, которые выдает <b>ipfw</b>.<br><br></dd>
<dt><b>net.inet.ip.fw.one_pass:</b> 1</dt><dd>
При установке значения 1 пакет, выходящий из канала <b>dummynet(4)</b> не проходит
снова через брандмауэр.	В противном случае, после выполнения действия канала,
пакет повторно попадает на брандмауэр и проверяется, начиная со следующего правила.<br><br></dd>
<dt><b>net.inet.ip.fw.verbose</b>: 1</dt><dd>
Включает выдачу подробных сообщений.<br><br></dd>
<dt><b>net.inet.ip.fw.enable</b>: 1</dt><dd>
Включает брандмауэр. При установке значения 0 машина будет работать без брандмауэра,
даже если он скомпилирован в ядро.<br><br></dd>
<dt><b>net.inet.ip.fw.verbose_limit</b>: 0</dt><dd>
Ограничивает количество сообщений, выдаваемых брандмауэром в режиме выдачи
подробных сообщений.
<br><br></dd>
<dt>
<b>net.inet.ip.fw.dyn_buckets</b>: 256<br>
<b>net.inet.ip.fw.curr_dyn_buckets</b>: 256</dt><dd>
Первоначально сконфигурированный и текущий размер хеш-таблицы, использующейся
для хранения динамических правил. Значение должно быть степенью 2. Размер таблицы
можно менять только когда она пуста, так что для изменения размера на ходу,
вероятно, придется сбросить (<b>flush</b>) и повторно загрузить набор правил.<br><br></dd>
<dt><b>net.inet.ip.fw.dyn_count</b>: 3</dt><dd>
Текущее количество динамических правил (доступна только для чтения).<br><br></dd>
<dt><b>net.inet.ip.fw.dyn_max</b>: 1000</dt><dd>
Максимальное количество динамических правил. При достижении этого предела
нельзяч больше добавлять динамические правила, пока прежние не устареют.
<br><br></dd>
<dt>
<b>net.inet.ip.fw.dyn_ack_lifetime</b>: 300<br>
<b>net.inet.ip.fw.dyn_syn_lifetime</b>: 20<br>
<b>net.inet.ip.fw.dyn_fin_lifetime</b>: 20<br>
<b>net.inet.ip.fw.dyn_rst_lifetime</b>: 5<br>
<b>net.inet.ip.fw.dyn_short_lifetime</b>: 30</dt><dd>
Эти переменные задают время существования динамических правил в секундах.
При перовначальном обмене SYN-пакетами время существования устанавливается
небольшим, а после получения обоих SYN-пакетов увеличивается, и снова
уменьшается в ходе обмена завершающими пакетами FIN или RST.
</dd>
</dl>

<h2><a name="examples">ПРИМЕРЫ</a></h2>

<p>Следующая команда добавляет запись, которая отвергает перенаправление текущим хостом
всех tcp-пакетов от хоста <b>cracker.evil.org</b> на порт <b>telnet</b> 
хоста <b>wolf.tambov.su</b>:</p>
<dl><dt></dt><dd><tt>
	   ipfw add deny tcp from cracker.evil.org to wolf.tambov.su telnet
</tt></dd></dl>
Следующая команда запрещает любое подключение из сети взломщиков к моему хосту:
<dl><dt></dt><dd><tt>
	   ipfw add deny ip from 123.45.67.0/24 to my.host.org
</tt></dd></dl>
Основной и эффективный способ ограничить доступ (без использования динамических правил) -
использовать правила следующего типа:
<dl><dt></dt><dd><tt>
	   ipfw add allow tcp from any to any established<br>
	   ipfw add allow tcp from net1 portlist1 to net2 portlist2 setup<br>
	   ipfw add allow tcp from net3 portlist3 to net3 portlist3 setup<br>
	   ...<br>
	   ipfw add deny tcp from any to any 
</tt></dd></dl>

Первому правилу соответствуют обычные пакеты TCP, но ему не соответствует
исходный пакет SYN, который будет соответствовать правилам <b>setup</b>
только для избранных пар иходный адрес/целевой адрес. Все остальные пакеты SYN
будут отвергаться завершающим правилом <b>deny</b>.

<p>Для защиты сайта от атак шквалом поддельных пакетов TCP,
безопаснее использовать динамические правила:</p>

<dl><dt></dt><dd><tt>
	   ipfw add check-state<br>
	   ipfw add deny tcp from any to any established<br>
	   ipfw add allow tcp from my-net to any setup keep-state
</tt></dd></dl>

Это позволит брандмауэру устанавливать динамические правила только для
подключения, которое начинается с обычного пакета SYN, поступающего из
нашей сети. Динамические правила проверяются при обработке первого правила
<b>check-state</b> или <b>keep-state</b>. Правило <b>check-state</b> обычно
надо помещать ближе к началу набора правил, чтобы уменьшить объем работы при
просмотре набора правил. Но возможны и другие решения.

<p><i>УЧТИТЕ</i>: правила, учитывающие состояние, уязвимы для атак на службы 
(denial-of-service attacks) путем забрасывания шквалом SYN-пакетов, что приводит к
созданию множества динамических правил. Ущерб от таких атак можно частично ограничить
путем установки соответствующих переменных <b><a href="/man.shtml?topic=sysctl&amp;category=8">sysctl(8)</a></b>,
которые управляют работой брандмауэра.</p>

<p>Вот хороший пример использования команды <b>list</b> для просмотра учетных записей
и информации о временных отметках:</p>
<dl><dt></dt><dd><tt>
	   ipfw -at list
</tt></dd></dl>
<p>или в сокращенном виде, без временных отметок:</p>
<dl><dt></dt><dd><tt>
	   ipfw -a list
</tt></dd></dl>
<p>Следующее правило перенаправляет все входящие пакеты от <b>192.168.2.0/24</b> на порт 5000:</p>
<dl><dt></dt><dd><tt>
	   ipfw divert 5000 ip from 192.168.2.0/24 to any in
</tt></dd></dl>
<p>Следующие правила показывают некоторые варианты применения средств <b>ipfw</b>
и <b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b> для имитации и моделирования.</p>

<p>Это правило теряет случайные входящие пакеты с вероятностью 5%:</p>
<dl><dt></dt><dd><tt>
	   ipfw add prob 0.05 deny ip from any to any in
</tt></dd></dl>
<p>Аналогичного эффекта можно добиться с помощью каналов <b>dummynet</b>:</p>
<dl><dt></dt><dd><tt>
	   ipfw add pipe 10 ip from any to any<br>
	   ipfw pipe 10 config plr 0.05
</tt></dd></dl>
<p>Можно использовать каналы для искусственного ограничения пропускной способности, например,
если на машине, работающей как маршрутизатор, необходимо ограничить объем данных, передаваемых
локальными клиентами в сети <b>192.168.2.0/24</b>, можно задать правила:</p>
<dl><dt></dt><dd><tt>
	   ipfw add pipe 1 ip from 192.168.2.0/24 to any out<br>
	   ipfw pipe 1 config bw 300Kbit/s queue 50KBytes
</tt></dd></dl>
<p>Обратите внимание на использование модификатора <b>out</b> - в результате правило не
используется дважды. Запомните, что правила <b>ipfw</b> проверяются как
для входящих, так и для исходящих пакетов.</p>

<p>При необходимости сымитировать двунаправленную связь с ограниченной пропускной 
способностью, это следует делать так:</p>
<dl><dt></dt><dd><tt>
	   ipfw add pipe 1 ip from any to any out<br>
	   ipfw add pipe 2 ip from any to any in<br>
	   ipfw pipe 1 config bw 500Kbit/s queue 100 red 0.002/30/80/0.1
</tt></dd></dl>
<p>Еще одно типичное приминение формирователя трафика связано с добавлением некоторых
задержек при взаимодействии. Это может повлиять на многие приложения, выполняющие
много вызовов удаленных процедур, когда время обмена данными (round-trip-time) по подключению
часто становится намного более существенным ограничением, чем пропускная способность:</p>
<dl><dt></dt><dd><tt>
	   ipfw add pipe 1 ip from any to any out<br>
	   ipfw add pipe 2 ip from any to any in<br>
	   ipfw pipe 1 config delay 250ms bw 1Mbit/s<br>
	   ipfw pipe 2 config delay 250ms bw 1Mbit/s
</tt></dd></dl>
<p>Отдельные очереди для потоков могут пригодиться для различных целей. Например, для подсчета 
объема переданных данных:</p>
<dl><dt></dt><dd><tt>
	   ipfw add pipe 1 tcp from any to any<br>
	   ipfw add pipe 1 udp from any to any<br>
	   ipfw add pipe 1 ip from any to any<br>
	   ipfw pipe 1 config mask all
</tt></dd></dl>
<p>Представленный выше набор правил создаст очереди (и будет собирать статистическую
информацию) для всех передаваемых данных. Поскольку каналы не накладывают никаких ограничений,
в результате будет только собираться статистическая информация. Учтите, что необходимы
3 правила, а не только последнее, поскольку когда программа <b>ipfw</b> пытается сопоставить IP-пакеты,
она не учитвает порты, поэтому нельзя будет различить подключения к разным портам.</p>

<p>Более сложный пример связан с ограничением объема исходящих из сети данных с ограничениями
по отдельным хостам, а не по сетям:</p>
<dl><dt></dt><dd><tt>
	   ipfw add pipe 22.06.031 ip from 192.168.2.0/24 to any out<br>
	   ipfw add pipe 2 ip from any to 192.168.2.0/24 in<br>
	   ipfw pipe 1 config mask src-ip 0x000000ff bw 200Kbit/s queue 20Kbytes<br>
	   ipfw pipe 2 config mask dst-ip 0x000000ff bw 200Kbit/s queue 20Kbytes
</tt></dd></dl>

<h2><a name="see_also">ССЫЛКИ</a></h2>

<dl><dt></dt><dd>
<b><a href="/man.shtml?topic=cpp&amp;category=1">cpp(1)</a></b>, 
<b><a href="/man.shtml?topic=m&amp;category=4">m4(1)</a></b>, 
<b><a href="/man.shtml?topic=bridge&amp;category=4">bridge(4)</a></b>, 
<b><a href="/man.shtml?topic=divert&amp;category=4">divert(4)</a></b>, 
<b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b>, 
<b><a href="/man.shtml?topic=ip&amp;category=4">ip(4)</a></b>, 
<b><a href="/man.shtml?topic=ipfirewall&amp;category=4">ipfirewall(4)</a></b>,
<b><a href="/man.shtml?topic=protocols&amp;category=5">protocols(5)</a></b>, 
<b><a href="/man.shtml?topic=services&amp;category=5">services(5)</a></b>, 
<b><a href="/man.shtml?topic=init&amp;category=8">init(8)</a></b>, 
<b><a href="/man.shtml?topic=kldload&amp;category=8">kldload(8)</a></b>, 
<b><a href="/man.shtml?topic=reboot&amp;category=8">reboot(8)</a></b>, 
<b><a href="/man.shtml?topic=sysctl&amp;category=8">sysctl(8)</a></b>,
<b><a href="/man.shtml?topic=syslogd&amp;category=8">syslogd(8)</a></b>
</dd></dl>

<h2><a name="bugs">ОШИБКИ</a></h2>

<p>Ситаксис складывался исторически и не слишком прозрачен.</p>

<p><i>ПРЕДУПРЕЖДЕНИЕ!!ПРЕДУПРЕЖДЕНИЕ!!ПРЕДУПРЕЖДЕНИЕ!!</i></p>

<p>Эта программа может сделать работу с компьютером практически невозможной. При первом использовании
работать надо за консолью и <i>НЕ</i> делать ничего, что вы не понимаете.</p>

<p>При изменении/добавлении записей в цепочки имена служб и протоколов испольбзовать нельзя.</p>

<p>Фрагменты входящих пакетов, перенаправленные с помощью <b>divert</b> или <b>tee</b>, повторно
собираются перед доставкой на соответствующий сокет.</p>

<p>Пакеты, соответствующие правилу <b>tee</b>, не должны приниматься немедленно, а должны
проходить дальше по списку правил. Эта ошибка может быть исправлена в следующей версии.</p>

<h2><a name="authors">АВТОРЫ</a></h2>

<dl><dt></dt><dd>
Юрген Анцилевич (Ugen J. S. Antsilevich),<br>
Пол-Хёнинг Камп (Poul-Henning Kamp),<br>
Алекс Нэш (Alex Nash),<br>
Арчи Коббс (Archie Cobbs),<br>
Луиджи Риццо (Luigi Rizzo).
</dd></dl>

<p>Функциональный интерфейс (API) основан на коде, написанном Дэниэлем Буле (Daniel Boulet)
для BSDI.</p>

<p>Работу над формирователем трафика <b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b>
поддерживала корпорация Akamba Corp.</p>

<h2><a name="history">ИСТОРИЯ</a></h2>

<p>Утилита <b>ipfw</b> впервые появилась в ОС FreeBSD 2.0. 
Интерфейс <b><a href="/man.shtml?topic=dummynet&amp;category=4">dummynet(4)</a></b> был добавлен в FreeBSD 2.2.8.
Расширения, связанные с запоминанием состояния, появились в ОС FreeBSD 4.0.</p>

<p align="center">FreeBSD 4.4, 16 февраля 2000 года</p>

<p align="center"><font size="-2">Copyleft (no c) - <b>Fuck copyright!</b> 2003 
<a href="mailto:valera@openxs.kiev.ua">В. Кравчук</a>,
<a href="http://ln.com.ua/~openxs">OpenXS Initiative</a>, перевод на русский язык
</font></p>

<br>
<form method="get" action="/search.shtml">
<font size="-1">
<font color="#555555">Поиск по тексту MAN-ов:&nbsp;</font><input size="30" name="words" value="ipfw" type="text">
<input name="restrict" value="/man" type="hidden">
<input value="Найти" type="submit">
</font>
<input name="method" value="and" type="hidden">
<input name="format" value="builtin-long" type="hidden">
<input name="sort" value="score" type="hidden">
</form>
<br>
<!--htdig_noindex-->
<noindex>
<br>


</noindex>
<!--/htdig_noindex-->


<!-- footer -->
<!--htdig_noindex-->
<br><br>
<div style="background-color: #E9EAD6; width:100%; height: 61px;">
<div style="margin-right: 20px; float:left; line-height: 61px; vertical-align: middle; margin-left: 10px; font-size: 120%;">
Спонсоры:
</div>
<div style="float:left; height: 60px;  line-height: 60px; margin-left: 20px;">
<a style="align: middle;" target="_blank" href="https://inferno.name/"><img src="/img/inferno2.png" alt="Inferno Solutions" height="57" width="200"></a>
</div>
<div style="float:right; height: 60px;  line-height: 60px;  margin-left: 15px;">
<a style="align: middle;" target="_blank" href="http://hoster.ru/?utm_source=site&amp;utm_medium=banner&amp;utm_campaign=opennet"><img src="/img/dh143x60t.png" alt="Hosting by Hoster.ru" height="60" width="143"></a>
</div>
<div style="float:right;  height: 60px;  line-height: 60px; vertical-align: middle;font-size: 120%;">
Хостинг:
</div>

</div>

<div style="clear: both;"></div>


<br>
<table class="ttxt" style="border-top: 3px solid #C9CaB6;">
<tbody><tr><td width="35%">
<a href="/cgi-bin/opennet/bookmark.cgi">Закладки на сайте</a><br>
<a href="/cgi-bin/opennet/bookmark.cgi?submit=add" target="blank_">Проследить за страницей</a>
</td>
<td align="RIGHT" width="65%">
Created&nbsp;1996-2021&nbsp;by <b><a href="/contact.shtml" title="email maxim.chirkov@gmail.com">Maxim&nbsp;Chirkov</a></b><br>
<a href="https://www.opennet.ru/add.shtml">Добавить</a>, <a href="https://www.opennet.ru/donate.shtml" style="color: #C00000;">Поддержать</a>, <a href="https://www.opennet.ru/banners2.shtml">Вебмастеру</a>
</td>
</tr>
</tbody></table>
<br><br>


<!--/htdig_noindex-->
<!-- end of footer -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-123449-1', 'auto');
    ga('send', 'pageview');
</script>




</body>
<!---------------------------------------------  0  ---------------------------------------------->
